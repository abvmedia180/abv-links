<!DOCTYPE html>
<html lang="en"><head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ABV Financial Intelligence ‚Äî Flip Tax Calculator</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0%25' stop-color='%2300d474'/%3E%3Cstop offset='100%25' stop-color='%2300b862'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='32' height='32' rx='6' fill='%23080a0f'/%3E%3Ctext x='16' y='22' text-anchor='middle' font-family='Georgia,serif' font-weight='700' font-size='16' fill='url(%23g)'%3EABV%3C/text%3E%3C/svg%3E">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Fraunces:opsz,wght@9..144,300;9..144,500;9..144,700;9..144,800&family=Fraunces:ital,opsz,wght@1,9..144,400&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root{--bg:#080a0f;--bg2:#0c0f16;--bg3:#111521;--bg4:#161b2b;--bd:#1e2740;--bd2:#283350;--mt:#6b7394;--tx:#a0a8c0;--br:#ccd6f6;--wh:#e6f1ff;--ac:#00d474;--ac2:#00b862;--acd:rgba(0,212,116,.06);--ac15:rgba(0,212,116,.15);--rd:#ff5252;--rdd:rgba(255,82,82,.06);--am:#ffc107;--inv1:#6366f1;--inv2:#10b981;--inv3:#f59e0b;--inv4:#f43f5e;--R:8px;--Rs:5px;--sans:'Inter',system-ui,sans-serif;--disp:'Fraunces',Georgia,serif}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:var(--sans);background:var(--bg);color:var(--tx);min-height:100vh;font-size:14px;line-height:1.6;-webkit-font-smoothing:antialiased}
.pulse-dot{position:relative;width:12px;height:12px;display:inline-block}
.pulse-dot::before{content:'';position:absolute;inset:1px;border-radius:50%;background:var(--ac);animation:pulseCore 2s ease-in-out infinite;box-shadow:0 0 6px var(--ac)}
.pulse-dot::after{content:'';position:absolute;inset:-6px;border-radius:50%;border:2px solid var(--ac);opacity:0;animation:pulseRing 2s ease-out infinite}
@keyframes pulseCore{0%,100%{opacity:1;transform:scale(1);box-shadow:0 0 6px var(--ac)}50%{opacity:.7;transform:scale(.8);box-shadow:0 0 12px var(--ac)}}
@keyframes pulseRing{0%{opacity:.6;transform:scale(.4)}100%{opacity:0;transform:scale(2.5)}}
.hero{position:relative;padding:72px 24px 36px;text-align:center;border-bottom:1px solid var(--bd)}
.htag{display:inline-flex;align-items:center;gap:10px;font-size:10px;font-weight:700;letter-spacing:1.5px;color:var(--ac);text-transform:uppercase;margin-bottom:14px}
.hero h1{font-family:var(--disp);font-size:clamp(1.6rem,4vw,2.4rem);font-weight:600;color:var(--wh);margin-bottom:8px}
.hero h1 em{font-family:var(--disp);font-style:italic;color:var(--ac)}
.hero>p{font-size:13px;color:var(--mt);max-width:560px;margin:0 auto}
.con{max-width:1400px;margin:0 auto;padding:24px 20px}
.card{background:var(--bg3);border:1px solid var(--bd);border-radius:var(--R);padding:20px;margin-bottom:14px;transition:border-color .2s}
.card:hover{border-color:var(--bd2)}
.ct{font-size:11px;font-weight:700;letter-spacing:.5px;text-transform:uppercase;color:var(--br);margin-bottom:12px;display:flex;align-items:center;gap:8px}
.ct::before{content:'';width:3px;height:12px;background:var(--ac);border-radius:2px}
.nb{position:sticky;top:48px;z-index:100;background:rgba(8,10,15,.96);backdrop-filter:blur(16px);border-bottom:1px solid var(--bd);padding:0 16px}
.ni{max-width:1400px;margin:0 auto;display:flex;gap:0;overflow-x:auto;scrollbar-width:none}.ni::-webkit-scrollbar{display:none}
.nt{padding:11px 14px;font-size:11.5px;font-weight:600;color:var(--mt);cursor:pointer;white-space:nowrap;border-bottom:2px solid transparent;transition:all .2s;user-select:none}
.nt:hover{color:var(--tx)}.nt.a{color:var(--ac);border-bottom-color:var(--ac)}
.igrp{margin-bottom:12px}.igrp label{display:block;font-size:10px;font-weight:700;letter-spacing:.6px;text-transform:uppercase;color:var(--mt);margin-bottom:5px}
.ninput{background:var(--bg4);border:1px solid var(--bd);border-radius:var(--Rs);padding:10px 12px;font-size:14px;font-weight:500;color:var(--wh);width:100%;font-family:var(--sans);transition:border-color .2s}
.ninput:hover,.ninput:focus{border-color:var(--ac);outline:none}
.nselect{background:var(--bg4);border:1px solid var(--bd);border-radius:var(--Rs);padding:10px 12px;font-size:13px;font-weight:500;color:var(--wh);width:100%;font-family:var(--sans);cursor:pointer;-webkit-appearance:none}
.nselect:hover,.nselect:focus{border-color:var(--ac);outline:none}
.tooltip{font-size:10px;color:var(--mt);font-style:italic;margin-top:4px}
.toggle{position:relative;width:36px;height:20px;background:var(--bd);border-radius:10px;cursor:pointer;transition:background .2s;display:inline-block;flex-shrink:0}
.toggle.on{background:var(--ac)}
.toggle::after{content:'';position:absolute;top:2px;left:2px;width:16px;height:16px;background:var(--wh);border-radius:50%;transition:transform .2s}
.toggle.on::after{transform:translateX(16px)}
.callout{padding:16px;border-radius:var(--Rs);margin-bottom:14px;line-height:1.7}
.callout.green{background:var(--acd);border:1px solid var(--ac15)}
.callout.blue{background:rgba(99,102,241,.05);border:1px solid rgba(99,102,241,.15)}
.callout .cl-t{font-size:12px;font-weight:700;margin-bottom:6px}
.callout .cl-b{font-size:12px;color:var(--br);line-height:1.8}
.callout .cl-b b{color:var(--wh)}
.inv-card{border-radius:var(--R);padding:16px;border:1px solid var(--bd)}
.inv-card.c0{background:rgba(99,102,241,.06);border-color:rgba(99,102,241,.18)}
.inv-card.c1{background:rgba(16,185,129,.06);border-color:rgba(16,185,129,.18)}
.inv-card.c2{background:rgba(245,158,11,.06);border-color:rgba(245,158,11,.18)}
.inv-card.c3{background:rgba(244,63,94,.06);border-color:rgba(244,63,94,.18)}
.inv-badge{display:inline-flex;align-items:center;justify-content:center;width:24px;height:24px;border-radius:50%;font-size:11px;font-weight:800;color:var(--bg);flex-shrink:0}
.inv-badge.c0{background:var(--inv1)}.inv-badge.c1{background:var(--inv2)}.inv-badge.c2{background:var(--inv3)}.inv-badge.c3{background:var(--inv4)}
.qsplit{display:inline-flex;padding:6px 12px;background:var(--bg4);border:1px solid var(--bd);border-radius:var(--Rs);font-size:11px;font-weight:600;color:var(--mt);cursor:pointer;transition:all .2s;font-family:var(--sans)}
.qsplit:hover{border-color:var(--ac);color:var(--ac)}
.qsplit.active{background:var(--ac);border-color:var(--ac);color:var(--bg)}
input[type=range]{-webkit-appearance:none;width:100%;height:6px;border-radius:3px;background:var(--bg4);outline:none;border:1px solid var(--bd);cursor:pointer;transition:background .15s}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:22px;height:22px;border-radius:6px;background:var(--ac);cursor:grab;border:2px solid var(--bg);box-shadow:0 2px 8px rgba(0,212,116,.3);transition:transform .1s,box-shadow .1s}
input[type=range]::-webkit-slider-thumb:active{cursor:grabbing;transform:scale(1.15);box-shadow:0 2px 12px rgba(0,212,116,.5)}
input[type=range]::-moz-range-thumb{width:22px;height:22px;border-radius:6px;background:var(--ac);cursor:grab;border:2px solid var(--bg);box-shadow:0 2px 8px rgba(0,212,116,.3)}
input[type=range]::-moz-range-thumb:active{cursor:grabbing;transform:scale(1.15)}
.sec{display:none;animation:fu .3s ease}.sec.a{display:block}
@keyframes fu{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.summary-bar{position:sticky;bottom:0;z-index:50;background:rgba(8,10,15,.95);backdrop-filter:blur(16px);border-top:1px solid var(--bd);padding:8px 16px}
.summary-inner{max-width:1400px;margin:0 auto;display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:center}
.summary-chip{padding:6px 12px;border-radius:var(--Rs);text-align:center;min-width:90px}
.summary-chip .sc-l{font-size:9px;font-weight:700;letter-spacing:.5px;text-transform:uppercase;color:var(--mt)}
.summary-chip .sc-v{font-family:var(--disp);font-size:16px;font-weight:700}
.chart-wrap{position:relative;width:100%;height:320px;margin:16px 0}
.chart-wrap canvas{width:100%!important;height:100%!important}
.ft{margin-top:32px;padding:24px;border-top:1px solid var(--bd);text-align:center}
.ft .v{font-size:11px;color:var(--mt);margin-bottom:8px}.ft .d{font-size:10px;color:rgba(255,255,255,.2);line-height:1.8;max-width:600px;margin:0 auto}
.tw{overflow-x:auto;border-radius:var(--Rs);border:1px solid var(--bd)}
.tbl{width:100%;border-collapse:collapse}
.tbl th{text-align:left;font-size:10px;font-weight:700;letter-spacing:.5px;text-transform:uppercase;color:var(--mt);padding:8px 10px;border-bottom:1px solid var(--bd);background:var(--bg4);white-space:nowrap}
.tbl td{padding:8px 10px;font-size:13px;border-bottom:1px solid rgba(30,39,64,.5);font-variant-numeric:tabular-nums;white-space:nowrap}
.tbl tr:hover{background:var(--acd)}
.tbl .right{text-align:right}
.best-row{background:rgba(0,212,116,.06)!important}
.worst-row{background:rgba(255,82,82,.04)!important}
@media(max-width:768px){.hero{padding:28px 12px 20px}.con{padding:16px 10px}.inv-grid{grid-template-columns:1fr!important}.res-grid{grid-template-columns:1fr!important}.chart-wrap{height:250px}.summary-chip{min-width:70px;padding:4px 8px}.summary-chip .sc-v{font-size:13px}.callout{padding:12px}}
@media(max-width:600px){.hero{padding:80px 16px 24px}.hero .htag{display:none}.hero h1{font-size:1.4rem;margin-bottom:10px}.hero>p{font-size:12px}}
@media(max-width:480px){.ninput,.nselect{font-size:16px!important}}

/* ‚ïê‚ïê SITE-WIDE NAVIGATION ‚ïê‚ïê */
.site-nav{position:fixed;top:0;left:0;right:0;z-index:200;background:rgba(8,10,15,.98);backdrop-filter:blur(20px);border-bottom:1px solid var(--bd);height:48px;display:flex;align-items:center;padding:0 20px}
.site-nav-inner{max-width:1400px;margin:0 auto;width:100%;display:flex;align-items:center;justify-content:space-between;gap:12px}
.site-logo{font-family:var(--disp);font-size:15px;font-weight:600;color:var(--wh);text-decoration:none;white-space:nowrap;flex-shrink:0}
.site-logo em{font-style:italic;color:var(--ac)}
.site-links{display:flex;gap:4px;overflow-x:auto;scrollbar-width:none}
.site-links::-webkit-scrollbar{display:none}
.site-links a{padding:6px 14px;font-size:11.5px;font-weight:600;color:var(--mt);text-decoration:none;border-radius:var(--Rs);transition:all .2s;white-space:nowrap;font-family:var(--sans)}
.site-links a:hover{color:var(--tx);background:var(--bg4)}
.site-links a.active{color:var(--ac);background:var(--acd)}
@media(max-width:600px){.site-nav{height:auto;padding:8px 16px}.site-nav-inner{flex-direction:column;gap:6px}.site-logo{font-size:13px}.site-links{justify-content:center}.site-links a{font-size:10px;padding:5px 10px}}
@media(max-width:480px){.site-links a{font-size:9.5px;padding:4px 8px}}
</style></head>
<body>
<div class="site-nav"><div class="site-nav-inner">
<a href="index.html" class="site-logo">ABV <em>Financial Intelligence</em></a>
<div class="site-links"><a href="index.html">Personal Finance</a><a href="grievance.html">Tax Grievance Guide</a><a href="flip-calculator.html" class="active">Real Estate Calculators</a></div>
</div></div>


<div class="hero">
<div class="htag"><div class="pulse-dot"></div> Financial Intelligence Platform</div>
<h1>Real Estate Flip <em>Tax Calculator</em></h1>
<p>Multi-investor scenario analyzer ¬∑ Federal, state, SE & NIIT ¬∑ 2025 tax brackets</p>
</div>

<div class="nb"><div class="ni">
<div class="nt a" onclick="switchTab('setup')">Setup</div>
<div class="nt" onclick="switchTab('results')">Results & Split</div>
<div class="nt" onclick="switchTab('scenarios')">All Scenarios</div>
<div class="nt" onclick="switchTab('charts')">Charts</div>
</div></div>

<div class="con">

<!-- SETUP TAB -->
<div class="sec a" id="sec-setup">
<div class="callout green">
<div class="cl-t" style="color:var(--ac)">üìã HOW FLIP PROFITS ARE TAXED</div>
<div class="cl-b">
When you buy a property with the <b>intent to renovate and resell for profit</b>, the IRS considers you a <b>dealer</b> ‚Äî not an investor. This means your profit is taxed as <b>ordinary business income</b>, regardless of how long you hold the property.<br><br>
Even if you hold it for 2 years, it's still ordinary income because flipping is your business activity. The long-term capital gains rate does <b>not</b> apply to flips. What matters is <b>intent at the time of purchase</b>.<br><br>
<b style="color:var(--ac)">Bottom line:</b> Flip profits are subject to federal income tax at your marginal rate (up to 37%) + state tax + potentially self-employment tax (15.3%) if you're actively involved.
</div></div>

<div class="callout blue">
<div class="cl-t" style="color:var(--inv1)">üë§ ACTIVE vs PASSIVE ‚Äî THE TOGGLE EXPLAINED</div>
<div class="cl-b">
<b style="color:var(--wh)">Active (toggle ON):</b> You materially participate ‚Äî finding deals, managing contractors, making decisions. Your share is subject to <b>self-employment tax (~15.3%)</b> on top of income tax.<br><br>
<b style="color:var(--wh)">Passive (toggle OFF):</b> You provide capital but don't participate day-to-day. You skip SE tax but may owe <b>NIIT (3.8%)</b> if income exceeds $200K single / $250K married.<br><br>
<b style="color:var(--ac)">Rule of thumb:</b> Running the project = Active. Wrote a check and someone else works = Passive.
</div></div>

<div class="card">
<div class="ct">Deal Setup</div>
<div style="display:grid;grid-template-columns:1fr auto;gap:16px;align-items:end">
<div class="igrp" style="margin-bottom:0">
<label>Total Flip Profit <span style="color:var(--rd)">*</span></label>
<input type="text" inputmode="decimal" class="ninput" id="flipProfit" value="200,000" oninput="fmtMoney(this);runAll()">
<div class="tooltip">Net profit after ALL expenses (purchase, rehab, closing costs, commissions)</div>
</div>
<div class="igrp" style="margin-bottom:0">
<label>Investors</label>
<div style="display:flex;gap:4px" id="invCountBtns">
<button class="qsplit" onclick="setInvCount(1)">1</button>
<button class="qsplit active" onclick="setInvCount(2)">2</button>
<button class="qsplit" onclick="setInvCount(3)">3</button>
<button class="qsplit" onclick="setInvCount(4)">4</button>
</div></div>
</div></div>

<div id="investorCards" class="inv-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:14px"></div>
</div>

<!-- RESULTS TAB -->
<div class="sec" id="sec-results">
<div class="card">
<div class="ct">Profit Split</div>
<div id="splitControls"></div>
<div id="splitWarning" style="display:none;margin-top:8px;padding:6px 10px;background:var(--rdd);border:1px solid rgba(255,82,82,.15);border-radius:var(--Rs);font-size:11px;color:var(--rd);font-weight:600"></div>
<div style="margin-top:10px;display:flex;gap:6px;flex-wrap:wrap" id="quickSplits"></div>
</div>
<div id="investorResults" class="res-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px"></div>
<div id="combinedSummary"></div>
</div>

<!-- SCENARIOS TAB -->
<div class="sec" id="sec-scenarios">
<div id="scenarioBestWorst" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:14px"></div>
<div id="scenarioTable"></div>
</div>

<!-- CHARTS TAB -->
<div class="sec" id="sec-charts">
<div class="card">
<div class="ct">Per-Investor Tax & Net by Scenario</div>
<div class="chart-wrap"><canvas id="chartTaxNet"></canvas></div>
</div>
<div class="card">
<div class="ct">Effective Tax Rate by Scenario</div>
<div class="chart-wrap"><canvas id="chartEffRate"></canvas></div>
</div>
</div>

</div><!-- /con -->

<div class="summary-bar" id="summaryBar" style="display:none">
<div class="summary-inner" id="summaryInner"></div>
</div>

<footer class="ft">
<div class="v">ABV Financial Intelligence Platform ¬∑ Flip Tax Calculator</div>
<div class="d">Estimates only ¬∑ 2025 federal & state brackets ¬∑ Not tax advice ¬∑ Does not account for AMT, phase-outs, QBI, or credits<br>Consult a CPA ¬∑ Built by Abe Varughese</div>
</footer>

<script>
// ‚ïê‚ïê‚ïê GLOBALS ‚ïê‚ïê‚ïê
const $f=v=>'$'+Math.round(v).toLocaleString('en-US');
const pct=v=>v.toFixed(1)+'%';
const INV_C=['#6366f1','#10b981','#f59e0b','#f43f5e'];
let invCount=2, splits=[50,50,0,0];
let chartA=null, chartB=null;

let investors=[
  {name:'',fs:'mfj',state:'NY',nyc:false,otherInc:80000,active:true},
  {name:'',fs:'mfj',state:'NY',nyc:false,otherInc:50000,active:false},
  {name:'',fs:'mfj',state:'NY',nyc:false,otherInc:0,active:false},
  {name:'',fs:'mfj',state:'NY',nyc:false,otherInc:0,active:false}
];

function getLabel(i){return investors[i].name||('Investor '+String.fromCharCode(65+i))}

// ‚ïê‚ïê‚ïê MONEY FORMAT ‚ïê‚ïê‚ïê
function fmtMoney(el){
  let cur=el.selectionStart, raw=el.value.replace(/[^0-9.\-]/g,'');
  if(!raw||raw==='-'){el.value=raw;return}
  let parts=raw.split('.'), intP=parts[0].replace(/[^0-9-]/g,'');
  let n=parseInt(intP); if(isNaN(n)){el.value=raw;return}
  let fmt=n.toLocaleString('en-US');
  if(parts.length>1)fmt+='.'+parts[1];
  let diff=fmt.length-el.value.length;
  el.value=fmt;
  el.setSelectionRange(Math.max(0,cur+diff),Math.max(0,cur+diff));
}
function getNum(id){let el=document.getElementById(id);return el?parseFloat(el.value.replace(/[,$]/g,''))||0:0}

// ‚ïê‚ïê‚ïê TAX DATA 2025 ‚ïê‚ïê‚ïê
const FED={
  single:[[0,11925,.10],[11925,48475,.12],[48475,103350,.22],[103350,197300,.24],[197300,250525,.32],[250525,626350,.35],[626350,1e15,.37]],
  mfj:[[0,23850,.10],[23850,96950,.12],[96950,206700,.22],[206700,394600,.24],[394600,501050,.32],[501050,751600,.35],[751600,1e15,.37]],
  mfs:[[0,11925,.10],[11925,48475,.12],[48475,103350,.22],[103350,197300,.24],[197300,250525,.32],[250525,375800,.35],[375800,1e15,.37]],
  hoh:[[0,17000,.10],[17000,64850,.12],[64850,103350,.22],[103350,197300,.24],[197300,250500,.32],[250500,626350,.35],[626350,1e15,.37]]
};
const SD={single:15000,mfj:30000,mfs:15000,hoh:22500};
const SS_CAP=176100;
const ADD_TH={single:200000,mfj:250000,mfs:125000,hoh:200000};
const NIIT_TH={single:200000,mfj:250000,mfs:125000,hoh:200000};
const NY_B=[[0,8500,.04],[8500,11700,.045],[11700,13900,.0525],[13900,80650,.0585],[80650,215400,.0625],[215400,1077550,.0685],[1077550,5000000,.0965],[5000000,25000000,.103],[25000000,1e15,.109]];
const NYC_B=[[0,12000,.03078],[12000,25000,.03762],[25000,50000,.03819],[50000,1e15,.03876]];
const CA_B=[[0,10412,.01],[10412,24684,.02],[24684,38959,.04],[38959,54081,.06],[54081,68350,.08],[68350,349137,.093],[349137,418961,.103],[418961,698271,.113],[698271,1000000,.123],[1000000,1e15,.133]];
const NJ_B=[[0,20000,.014],[20000,35000,.0175],[35000,40000,.035],[40000,75000,.05525],[75000,500000,.0637],[500000,1000000,.0897],[1000000,1e15,.1075]];
const CT_B=[[0,10000,.03],[10000,50000,.05],[50000,100000,.055],[100000,200000,.06],[200000,250000,.065],[250000,500000,.069],[500000,1e15,.0699]];
const SC_B=[[0,3460,0],[3460,17330,.03],[17330,1e15,.064]];
const WV_B=[[0,10000,.0236],[10000,25000,.0315],[25000,40000,.0354],[40000,60000,.0472],[60000,1e15,.0512]];
const NM_B=[[0,5500,.017],[5500,11000,.032],[11000,16500,.047],[16500,22000,.049],[22000,1e15,.059]];

const STATES=[
  {c:'NY',n:'New York',b:NY_B,city:1},{c:'NJ',n:'New Jersey',b:NJ_B},{c:'CT',n:'Connecticut',b:CT_B},
  {c:'PA',n:'Pennsylvania',flat:.0307},{c:'CA',n:'California',b:CA_B},
  {c:'NC',n:'North Carolina',flat:.0425},{c:'SC',n:'South Carolina',b:SC_B},
  {c:'GA',n:'Georgia',flat:.0539},{c:'IL',n:'Illinois',flat:.0495},
  {c:'WV',n:'West Virginia',b:WV_B},{c:'NM',n:'New Mexico',b:NM_B},
  {c:'FL',n:'Florida',flat:0},{c:'TX',n:'Texas',flat:0},
  {c:'NV',n:'Nevada',flat:0},{c:'WA',n:'Washington',flat:0},{c:'WY',n:'Wyoming',flat:0}
];

// ‚ïê‚ïê‚ïê TAX CALC ‚ïê‚ïê‚ïê
function calcBrk(inc,brk){let t=0;for(const[lo,hi,r]of brk){if(inc<=lo)break;t+=(Math.min(inc,hi)-lo)*r}return t}
function calcSt(inc,code){
  let s=STATES.find(x=>x.c===code);if(!s)return 0;
  if(s.flat!==undefined)return inc*s.flat;
  return s.b?calcBrk(inc,s.b):0;
}

function calcTax(inv,alloc){
  let fs=inv.fs, other=inv.otherInc, act=inv.active;
  let seTax=0, seDed=0;
  if(act&&alloc>0){
    let base=alloc*0.9235;
    let ssInc=Math.max(0,Math.min(base,SS_CAP-Math.max(0,other)));
    seTax=ssInc*0.124+base*0.029;
    let th=ADD_TH[fs]||200000, tot=other+base;
    if(tot>th)seTax+=Math.min(base,tot-th)*0.009;
    seDed=seTax*0.5;
  }
  let agi=other+alloc-seDed;
  let ded=SD[fs]||15000;
  let ti=Math.max(0,agi-ded);
  let tw=Math.max(0,(other-seDed)-ded);
  let brk=FED[fs]||FED.single;
  let fed=calcBrk(ti,brk)-calcBrk(Math.max(0,tw),brk);
  let niit=0;
  if(!act){let nth=NIIT_TH[fs]||200000;if(agi>nth)niit=Math.min(alloc,agi-nth)*0.038}
  let st=calcSt(ti,inv.state)-calcSt(Math.max(0,tw),inv.state);
  let city=0;
  if(inv.state==='NY'&&inv.nyc)city=calcBrk(ti,NYC_B)-calcBrk(Math.max(0,tw),NYC_B);
  let total=fed+seTax+niit+st+city;
  let eff=alloc>0?(total/alloc)*100:0;
  let marg=0;for(let i=brk.length-1;i>=0;i--){if(ti>brk[i][0]){marg=brk[i][2]*100;break}}
  return{alloc,fed,se:seTax,niit,st,city,total,eff,net:alloc-total,marg};
}

function compute(sp){
  let p=getNum('flipProfit'), res=[];
  for(let i=0;i<invCount;i++)res.push(calcTax(investors[i],p*(sp[i]||0)/100));
  let cTax=res.reduce((s,r)=>s+r.total,0), cNet=res.reduce((s,r)=>s+r.net,0);
  return{results:res,cTax,cNet,cRate:p>0?(cTax/p)*100:0};
}

function getSplits(){
  if(invCount===1)return[[100]];
  if(invCount===2)return[[50,50],[60,40],[40,60],[70,30],[30,70],[75,25],[25,75],[80,20],[20,80],[90,10],[10,90],[100,0],[0,100]];
  if(invCount===3)return[[34,33,33],[50,25,25],[25,50,25],[25,25,50],[60,20,20],[70,15,15],[80,10,10]];
  return[[25,25,25,25],[40,30,20,10],[50,25,15,10],[60,20,10,10],[30,30,30,10]];
}

// ‚ïê‚ïê‚ïê TAB NAV ‚ïê‚ïê‚ïê
function switchTab(id){
  document.querySelectorAll('.sec').forEach(s=>s.classList.remove('a'));
  document.querySelectorAll('.nt').forEach(t=>t.classList.remove('a'));
  document.getElementById('sec-'+id).classList.add('a');
  document.querySelector('[onclick*="'+id+'"]').classList.add('a');
  if(id==='results'){buildSplitUI();renderResults()}
  if(id==='scenarios')renderScenarios();
  if(id==='charts')renderCharts();
}

// ‚ïê‚ïê‚ïê INVESTOR CARDS ‚ïê‚ïê‚ïê
function buildInvestorCards(){
  let c=document.getElementById('investorCards');
  c.style.gridTemplateColumns=invCount<=2?'1fr 1fr':'repeat('+Math.min(invCount,4)+',1fr)';
  let h='';
  for(let i=0;i<invCount;i++){
    let inv=investors[i], lbl=String.fromCharCode(65+i);
    let stOpts='';STATES.forEach(s=>{stOpts+='<option value="'+s.c+'"'+(inv.state===s.c?' selected':'')+'>'+s.n+'</option>'});
    h+='<div class="inv-card c'+i+'">';
    h+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">';
    h+='<span class="inv-badge c'+i+'">'+lbl+'</span>';
    h+='<input type="text" class="ninput" value="'+inv.name+'" placeholder="Investor '+lbl+' Name" style="flex:1;font-weight:700;font-size:15px;padding:6px 10px" onchange="investors['+i+'].name=this.value;runAll()">';
    h+='</div>';
    h+='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;padding:8px;background:var(--bg4);border-radius:var(--Rs)">';
    h+='<div><span style="font-size:11px;font-weight:700;color:var(--br)">Role</span><br><span style="font-size:10px;color:var(--mt)">'+(inv.active?'Active ‚Äî pays SE tax':'Passive ‚Äî may owe NIIT')+'</span></div>';
    h+='<div style="display:flex;align-items:center;gap:6px"><span style="font-size:9px;color:var(--mt)">Passive</span>';
    h+='<div class="toggle'+(inv.active?' on':'')+'" onclick="investors['+i+'].active=!investors['+i+'].active;buildInvestorCards();runAll()"></div>';
    h+='<span style="font-size:9px;color:var(--mt)">Active</span></div></div>';
    h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px">';
    h+='<div class="igrp" style="margin:0"><label>Filing Status</label><select class="nselect" onchange="investors['+i+'].fs=this.value;runAll()"><option value="single"'+(inv.fs==='single'?' selected':'')+'>Single</option><option value="mfj"'+(inv.fs==='mfj'?' selected':'')+'>MFJ</option><option value="mfs"'+(inv.fs==='mfs'?' selected':'')+'>MFS</option><option value="hoh"'+(inv.fs==='hoh'?' selected':'')+'>HOH</option></select></div>';
    h+='<div class="igrp" style="margin:0"><label>State</label><select class="nselect" onchange="investors['+i+'].state=this.value;buildInvestorCards();runAll()">'+stOpts+'</select></div></div>';
    if(inv.state==='NY')h+='<label style="display:flex;align-items:center;gap:6px;margin-bottom:10px;cursor:pointer;font-size:12px;color:var(--br)"><input type="checkbox" '+(inv.nyc?'checked':'')+' onchange="investors['+i+'].nyc=this.checked;runAll()" style="accent-color:var(--ac)"> NYC Resident</label>';
    h+='<div class="igrp" style="margin:0"><label>Other Annual Income</label>';
    h+='<input type="text" inputmode="decimal" class="ninput" id="inv'+i+'inc" value="'+inv.otherInc.toLocaleString('en-US')+'" oninput="fmtMoney(this);investors['+i+'].otherInc=parseFloat(this.value.replace(/[,$]/g,\'\'))||0;runAll()">';
    h+='<div class="tooltip">W-2, K-1, other income that determines your bracket</div></div>';
    h+='</div>';
  }
  c.innerHTML=h;
}

function setInvCount(n){
  invCount=n;
  let each=Math.floor(100/n);splits=[0,0,0,0];
  for(let i=0;i<n;i++)splits[i]=each;
  splits[0]+=100-splits.reduce((a,b)=>a+b,0);
  document.querySelectorAll('#invCountBtns .qsplit').forEach((b,idx)=>b.classList.toggle('active',idx+1===n));
  buildInvestorCards();runAll();
}

// ‚ïê‚ïê‚ïê SPLIT CONTROLS (auto-balancing) ‚ïê‚ïê‚ïê
// When one slider moves, distribute the remainder proportionally among the others
function adjustSplits(changedIdx, newVal){
  newVal=Math.max(0,Math.min(100,Math.round(newVal)));
  let oldVal=splits[changedIdx];
  splits[changedIdx]=newVal;
  
  if(invCount===1){splits[0]=100;return}
  
  let remainder=100-newVal;
  let othersOldTotal=0;
  for(let i=0;i<invCount;i++){if(i!==changedIdx)othersOldTotal+=splits[i]}
  
  if(othersOldTotal>0){
    // Distribute proportionally based on current ratios
    let assigned=0;
    let lastOther=-1;
    for(let i=0;i<invCount;i++){
      if(i===changedIdx)continue;
      lastOther=i;
      let share=Math.round((splits[i]/othersOldTotal)*remainder);
      splits[i]=share;
      assigned+=share;
    }
    // Fix rounding ‚Äî give leftover to last other investor
    if(lastOther>=0)splits[lastOther]+=remainder-assigned;
  } else {
    // All others are 0 ‚Äî distribute evenly
    let otherCount=invCount-1;
    let each=Math.floor(remainder/otherCount);
    let extra=remainder-each*otherCount;
    for(let i=0;i<invCount;i++){
      if(i===changedIdx)continue;
      splits[i]=each;
      if(extra>0){splits[i]++;extra--}
    }
  }
  
  // Clamp all to 0-100
  for(let i=0;i<invCount;i++)splits[i]=Math.max(0,Math.min(100,splits[i]));
  // Zero out unused
  for(let i=invCount;i<4;i++)splits[i]=0;
}

function updateSplitDisplay(dragIdx){
  let p=getNum('flipProfit');
  let tot=splits.slice(0,invCount).reduce((a,b)=>a+b,0);
  // Update stacked bar segments
  var barSegs=document.querySelectorAll('#splitControls .split-bar-seg');
  barSegs.forEach(function(seg,i){if(i<invCount)seg.style.width=splits[i]+'%'});
  // Update slider values and text (skip the one being dragged)
  for(let i=0;i<invCount;i++){
    var slider=document.getElementById('splitRange'+i);
    var numInput=document.getElementById('splitNum'+i);
    var spanEl=document.getElementById('splitLabel'+i);
    if(slider&&i!==dragIdx)slider.value=splits[i];
    if(numInput)numInput.value=splits[i];
    if(spanEl)spanEl.textContent='% ¬∑ '+$f(p*splits[i]/100);
  }
  let w=document.getElementById('splitWarning');
  if(tot!==100){w.style.display='block';w.textContent='‚ö†Ô∏è '+tot+'% allocated'}else w.style.display='none';
}

function buildSplitUI(){
  let p=getNum('flipProfit');
  let tot=splits.slice(0,invCount).reduce((a,b)=>a+b,0);

  // Visual: stacked bar showing split allocation
  let barH='<div style="display:flex;height:8px;border-radius:4px;overflow:hidden;margin-bottom:16px;background:var(--bg4)">';
  for(let i=0;i<invCount;i++){
    if(splits[i]>0)barH+='<div class="split-bar-seg" style="width:'+splits[i]+'%;background:'+INV_C[i]+';transition:width .2s" title="'+getLabel(i)+': '+splits[i]+'%"></div>';
  }
  barH+='</div>';

  let h=barH+'<div style="display:grid;grid-template-columns:repeat('+invCount+',1fr);gap:14px">';
  for(let i=0;i<invCount;i++){
    h+='<div><label style="font-size:10px;font-weight:700;letter-spacing:.5px;text-transform:uppercase;color:'+INV_C[i]+';margin-bottom:4px;display:block">'+getLabel(i)+'</label>';
    h+='<input type="range" id="splitRange'+i+'" min="0" max="100" value="'+splits[i]+'" style="accent-color:'+INV_C[i]+'" oninput="adjustSplits('+i+',+this.value);updateSplitDisplay('+i+');renderResults()" onchange="buildSplitUI();renderResults()">';
    h+='<div style="display:flex;align-items:center;gap:6px;margin-top:4px">';
    h+='<input type="number" id="splitNum'+i+'" min="0" max="100" value="'+splits[i]+'" class="ninput" style="width:56px;text-align:center;padding:6px" onchange="adjustSplits('+i+',+this.value);buildSplitUI();renderResults()">';
    h+='<span id="splitLabel'+i+'" style="font-size:11px;color:var(--mt)">% ¬∑ '+$f(p*splits[i]/100)+'</span></div></div>';
  }
  h+='</div>';
  document.getElementById('splitControls').innerHTML=h;
  
  let w=document.getElementById('splitWarning');
  if(tot!==100){w.style.display='block';w.textContent='‚ö†Ô∏è '+tot+'% allocated'}else w.style.display='none';
  
  // Quick splits
  let presets=invCount===1?[[100]]:invCount===2?[[50,50],[60,40],[70,30],[80,20],[90,10]]:invCount===3?[[34,33,33],[50,25,25],[60,20,20]]:[[25,25,25,25],[40,30,20,10],[50,25,15,10]];
  let qh='<span style="font-size:10px;font-weight:700;color:var(--mt)">Quick:</span> ';
  presets.forEach(pr=>{
    let act=true;for(let i=0;i<invCount;i++)if(splits[i]!==(pr[i]||0))act=false;
    qh+='<button class="qsplit'+(act?' active':'')+'" onclick="splits=['+[...pr,...[0,0,0,0]].slice(0,4).join(',')+'];buildSplitUI();renderResults()">'+pr.slice(0,invCount).join('/')+'</button> ';
  });
  document.getElementById('quickSplits').innerHTML=qh;
}

// ‚ïê‚ïê‚ïê RESULTS ‚ïê‚ïê‚ïê
function renderResults(){
  let p=getNum('flipProfit'), res=compute(splits);
  let el=document.getElementById('investorResults');
  el.style.gridTemplateColumns=invCount<=2?'1fr 1fr':'repeat('+invCount+',1fr)';
  let h='';
  res.results.forEach((r,i)=>{
    h+='<div class="inv-card c'+i+'">';
    h+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><span class="inv-badge c'+i+'">'+String.fromCharCode(65+i)+'</span><span style="font-size:14px;font-weight:700;color:'+INV_C[i]+'">'+getLabel(i)+'</span><span style="margin-left:auto;font-size:11px;color:var(--mt)">'+splits[i]+'%</span></div>';
    h+='<div style="font-family:var(--disp);font-size:22px;font-weight:700;color:var(--wh);margin-bottom:10px">'+$f(r.alloc)+'</div>';
    h+='<div style="font-size:12px;color:var(--tx);line-height:2.1">';
    h+='<div style="display:flex;justify-content:space-between">Federal ('+pct(r.marg)+' bracket)<span style="color:var(--rd);font-weight:600">'+$f(r.fed)+'</span></div>';
    if(r.se>0)h+='<div style="display:flex;justify-content:space-between">Self-Employment Tax<span style="color:var(--rd);font-weight:600">'+$f(r.se)+'</span></div>';
    if(r.niit>0)h+='<div style="display:flex;justify-content:space-between">NIIT (3.8%)<span style="color:var(--rd);font-weight:600">'+$f(r.niit)+'</span></div>';
    if(r.st>0)h+='<div style="display:flex;justify-content:space-between">State Tax<span style="color:var(--am);font-weight:600">'+$f(r.st)+'</span></div>';
    if(r.city>0)h+='<div style="display:flex;justify-content:space-between">NYC Tax<span style="color:var(--am);font-weight:600">'+$f(r.city)+'</span></div>';
    h+='</div>';
    h+='<div style="border-top:1px solid var(--bd);margin-top:8px;padding-top:8px">';
    h+='<div style="display:flex;justify-content:space-between;font-size:12px"><span style="font-weight:700;color:var(--rd)">Total Tax</span><span style="font-weight:800;color:var(--rd)">'+$f(r.total)+'</span></div>';
    h+='<div style="display:flex;justify-content:space-between;font-size:12px;margin-top:2px"><span style="color:var(--mt)">Effective Rate</span><span style="font-weight:700;color:var(--mt)">'+pct(r.eff)+'</span></div>';
    h+='<div style="display:flex;justify-content:space-between;font-size:14px;margin-top:6px"><span style="font-weight:700;color:var(--ac)">Net After Tax</span><span style="font-weight:800;color:var(--ac);font-family:var(--disp);font-size:18px">'+$f(r.net)+'</span></div>';
    h+='</div></div>';
  });
  el.innerHTML=h;

  // Combined
  let ch='<div class="card" style="background:var(--bg4)"><div style="display:flex;flex-wrap:wrap;justify-content:space-around;gap:16px;text-align:center;padding:4px 0">';
  ch+='<div><div style="font-size:9px;font-weight:700;color:var(--mt);text-transform:uppercase;letter-spacing:.5px">Total Profit</div><div style="font-family:var(--disp);font-size:20px;font-weight:700;color:var(--wh)">'+$f(p)+'</div></div>';
  ch+='<div><div style="font-size:9px;font-weight:700;color:var(--rd);text-transform:uppercase;letter-spacing:.5px">Combined Tax</div><div style="font-family:var(--disp);font-size:20px;font-weight:700;color:var(--rd)">'+$f(res.cTax)+'</div></div>';
  ch+='<div><div style="font-size:9px;font-weight:700;color:var(--mt);text-transform:uppercase;letter-spacing:.5px">Eff. Rate</div><div style="font-family:var(--disp);font-size:20px;font-weight:700;color:var(--am)">'+pct(res.cRate)+'</div></div>';
  ch+='<div><div style="font-size:9px;font-weight:700;color:var(--ac);text-transform:uppercase;letter-spacing:.5px">Combined Net</div><div style="font-family:var(--disp);font-size:20px;font-weight:700;color:var(--ac)">'+$f(res.cNet)+'</div></div>';
  ch+='</div></div>';
  document.getElementById('combinedSummary').innerHTML=ch;

  // Summary bar
  let sb='';
  res.results.forEach((r,i)=>{
    sb+='<div class="summary-chip" style="border-left:3px solid '+INV_C[i]+'"><div class="sc-l">'+getLabel(i)+'</div><div class="sc-v" style="color:var(--ac)">'+$f(r.net)+'</div><div style="font-size:9px;color:var(--mt)">'+pct(r.eff)+' rate</div></div>';
  });
  sb+='<div class="summary-chip" style="border-left:3px solid var(--rd)"><div class="sc-l">Total Tax</div><div class="sc-v" style="color:var(--rd)">'+$f(res.cTax)+'</div></div>';
  sb+='<div class="summary-chip" style="border-left:3px solid var(--ac)"><div class="sc-l">Net</div><div class="sc-v" style="color:var(--ac)">'+$f(res.cNet)+'</div></div>';
  document.getElementById('summaryInner').innerHTML=sb;
  document.getElementById('summaryBar').style.display='block';
}

// ‚ïê‚ïê‚ïê SCENARIOS ‚ïê‚ïê‚ïê
function renderScenarios(){
  let p=getNum('flipProfit'), allSp=getSplits();
  let scenarios=allSp.map(sp=>{
    let pad=[sp[0]||0,sp[1]||0,sp[2]||0,sp[3]||0];
    let r=compute(pad);
    return{label:pad.slice(0,invCount).join('/'),sp:pad,...r};
  });
  let best=scenarios.reduce((b,s)=>s.cTax<b.cTax?s:b,scenarios[0]);
  let worst=scenarios.reduce((w,s)=>s.cTax>w.cTax?s:w,scenarios[0]);

  // Best/Worst callout
  let bw='';
  bw+='<div class="card" style="text-align:center;border-color:rgba(0,212,116,.2);background:var(--acd)"><div style="font-size:10px;font-weight:700;color:var(--ac);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">üèÜ Lowest Tax</div><div style="font-family:var(--disp);font-size:20px;font-weight:700;color:var(--wh)">'+best.label+'</div><div style="font-size:12px;color:var(--ac);font-weight:600">'+$f(best.cTax)+' ¬∑ '+pct(best.cRate)+'</div><div style="font-size:13px;font-weight:700;color:var(--ac);margin-top:4px">'+$f(best.cNet)+' net</div></div>';
  bw+='<div class="card" style="text-align:center;border-color:rgba(255,82,82,.2);background:var(--rdd)"><div style="font-size:10px;font-weight:700;color:var(--rd);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">‚ö†Ô∏è Highest Tax</div><div style="font-family:var(--disp);font-size:20px;font-weight:700;color:var(--wh)">'+worst.label+'</div><div style="font-size:12px;color:var(--rd);font-weight:600">'+$f(worst.cTax)+' ¬∑ '+pct(worst.cRate)+'</div><div style="font-size:13px;font-weight:700;color:var(--rd);margin-top:4px">'+$f(worst.cNet)+' net</div></div>';
  bw+='<div class="card" style="text-align:center;border-color:rgba(99,102,241,.2);background:rgba(99,102,241,.05)"><div style="font-size:10px;font-weight:700;color:var(--inv1);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">üí∞ Savings Potential</div><div style="font-family:var(--disp);font-size:20px;font-weight:700;color:var(--wh)">'+$f(worst.cTax-best.cTax)+'</div><div style="font-size:12px;color:var(--inv1);font-weight:600">Best vs worst split</div><div style="font-size:13px;color:var(--mt);margin-top:4px">on '+$f(p)+' profit</div></div>';
  document.getElementById('scenarioBestWorst').innerHTML=bw;

  // Table
  let th='<div class="card" style="padding:0;overflow:hidden"><div style="padding:12px 16px;background:var(--bg4);border-bottom:1px solid var(--bd)"><span style="font-size:12px;font-weight:700;color:var(--br)">All Scenarios ‚Äî '+$f(p)+' Profit</span></div><div class="tw"><table class="tbl"><thead><tr><th>Split</th>';
  for(let i=0;i<invCount;i++)th+='<th class="right" style="color:'+INV_C[i]+'">'+getLabel(i)+' Tax</th>';
  for(let i=0;i<invCount;i++)th+='<th class="right" style="color:'+INV_C[i]+'">'+getLabel(i)+' Net</th>';
  for(let i=0;i<invCount;i++)th+='<th class="right">'+getLabel(i)+' Rate</th>';
  th+='<th class="right" style="color:var(--rd)">Total Tax</th><th class="right">Eff Rate</th><th class="right" style="color:var(--ac)">Total Net</th></tr></thead><tbody>';
  scenarios.forEach(s=>{
    let isBest=s.label===best.label, isWorst=s.label===worst.label;
    th+='<tr class="'+(isBest?'best-row':isWorst?'worst-row':'')+'">';
    th+='<td style="font-weight:700;color:var(--wh)">'+(isBest?'üèÜ ':isWorst?'‚ö†Ô∏è ':'')+s.label+'</td>';
    s.results.forEach((r,i)=>{th+='<td class="right" style="color:var(--rd);font-weight:600">'+$f(r.total)+'</td>'});
    s.results.forEach((r,i)=>{th+='<td class="right" style="color:var(--ac);font-weight:600">'+$f(r.net)+'</td>'});
    s.results.forEach((r,i)=>{th+='<td class="right" style="color:var(--mt)">'+pct(r.eff)+'</td>'});
    th+='<td class="right" style="font-weight:800;color:var(--rd)">'+$f(s.cTax)+'</td>';
    th+='<td class="right" style="font-weight:700;color:var(--am)">'+pct(s.cRate)+'</td>';
    th+='<td class="right" style="font-weight:800;color:var(--ac)">'+$f(s.cNet)+'</td>';
    th+='</tr>';
  });
  th+='</tbody></table></div></div>';
  document.getElementById('scenarioTable').innerHTML=th;
}

// ‚ïê‚ïê‚ïê CHARTS ‚ïê‚ïê‚ïê
function renderCharts(){
  let p=getNum('flipProfit'), allSp=getSplits();
  let scenarios=allSp.map(sp=>{
    let pad=[sp[0]||0,sp[1]||0,sp[2]||0,sp[3]||0];
    let r=compute(pad);
    return{label:pad.slice(0,invCount).join('/'),...r};
  });
  let labels=scenarios.map(s=>s.label);
  
  // Chart 1: Per-investor Tax + Net
  if(chartA){chartA.destroy()}
  let ds1=[];
  for(let i=0;i<invCount;i++){
    ds1.push({label:getLabel(i)+' Tax',data:scenarios.map(s=>s.results[i].total),backgroundColor:INV_C[i]+'99',borderColor:INV_C[i],borderWidth:1,stack:'tax'});
    ds1.push({label:getLabel(i)+' Net',data:scenarios.map(s=>s.results[i].net),backgroundColor:INV_C[i]+'33',borderColor:INV_C[i],borderWidth:1,borderDash:[4,4],stack:'net'});
  }
  let ctx1=document.getElementById('chartTaxNet').getContext('2d');
  chartA=new Chart(ctx1,{type:'bar',data:{labels,datasets:ds1},options:{
    responsive:true,maintainAspectRatio:false,
    plugins:{legend:{labels:{color:'#6b7394',font:{size:10,family:'Inter'}}},tooltip:{backgroundColor:'#111521',borderColor:'#1e2740',borderWidth:1,titleColor:'#e6f1ff',bodyColor:'#a0a8c0',callbacks:{label:c=>c.dataset.label+': $'+Math.round(c.raw).toLocaleString()}}},
    scales:{x:{ticks:{color:'#6b7394',font:{size:9},maxRotation:45},grid:{color:'rgba(30,39,64,.3)'}},y:{ticks:{color:'#6b7394',font:{size:9},callback:v=>'$'+(v/1000).toFixed(0)+'k'},grid:{color:'rgba(30,39,64,.3)'}}}
  }});

  // Chart 2: Effective rate
  if(chartB){chartB.destroy()}
  let ds2=[];
  for(let i=0;i<invCount;i++){
    ds2.push({label:getLabel(i)+' Rate',data:scenarios.map(s=>parseFloat(s.results[i].eff.toFixed(1))),borderColor:INV_C[i],backgroundColor:INV_C[i]+'22',pointRadius:3,pointBackgroundColor:INV_C[i],tension:.3,fill:false});
  }
  ds2.push({label:'Combined Rate',data:scenarios.map(s=>parseFloat(s.cRate.toFixed(1))),borderColor:'#e6f1ff',backgroundColor:'transparent',borderDash:[6,3],pointRadius:3,pointBackgroundColor:'#e6f1ff',tension:.3,fill:false});
  let ctx2=document.getElementById('chartEffRate').getContext('2d');
  chartB=new Chart(ctx2,{type:'line',data:{labels,datasets:ds2},options:{
    responsive:true,maintainAspectRatio:false,
    plugins:{legend:{labels:{color:'#6b7394',font:{size:10,family:'Inter'}}},tooltip:{backgroundColor:'#111521',borderColor:'#1e2740',borderWidth:1,titleColor:'#e6f1ff',bodyColor:'#a0a8c0',callbacks:{label:c=>c.dataset.label+': '+c.raw.toFixed(1)+'%'}}},
    scales:{x:{ticks:{color:'#6b7394',font:{size:9},maxRotation:45},grid:{color:'rgba(30,39,64,.3)'}},y:{ticks:{color:'#6b7394',font:{size:9},callback:v=>v+'%'},grid:{color:'rgba(30,39,64,.3)'}}}
  }});
}

// ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê
function runAll(){
  let active=document.querySelector('.sec.a');
  if(active){
    let id=active.id.replace('sec-','');
    if(id==='results'){buildSplitUI();renderResults()}
    if(id==='scenarios')renderScenarios();
    if(id==='charts')renderCharts();
  }
  // Always update summary bar if we have results
  let res=compute(splits);
  let sb='';
  res.results.forEach((r,i)=>{
    sb+='<div class="summary-chip" style="border-left:3px solid '+INV_C[i]+'"><div class="sc-l">'+getLabel(i)+'</div><div class="sc-v" style="color:var(--ac)">'+$f(r.net)+'</div><div style="font-size:9px;color:var(--mt)">'+pct(r.eff)+'</div></div>';
  });
  sb+='<div class="summary-chip" style="border-left:3px solid var(--rd)"><div class="sc-l">Tax</div><div class="sc-v" style="color:var(--rd)">'+$f(res.cTax)+'</div></div>';
  sb+='<div class="summary-chip" style="border-left:3px solid var(--ac)"><div class="sc-l">Net</div><div class="sc-v" style="color:var(--ac)">'+$f(res.cNet)+'</div></div>';
  document.getElementById('summaryInner').innerHTML=sb;
  document.getElementById('summaryBar').style.display='block';
}

// Boot
buildInvestorCards();
</script>
</body></html>