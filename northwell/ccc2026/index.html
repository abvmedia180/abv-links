<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JEOPARDY! — CCC Retreat • Northwell Health • LIJ Medical Center</title>
<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --northwell-navy: #002855;
  --northwell-blue: #003DA5;
  --northwell-sky: #0077C8;
  --northwell-light: #4EA8DE;
  --northwell-accent: #00B2A9;
  --northwell-gold: #F2A900;
  --board-bg: #001A3A;
  --cell-bg: #002855;
  --cell-hover: #003870;
  --cell-used: #0D1B2A;
  --wrong-red: #E74C6F;
  --font-display: 'Oswald', sans-serif;
  --font-serif: 'Libre Baskerville', serif;
  --font-body: 'DM Sans', sans-serif;
  --radius: 8px;
  --transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
}
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
html, body { height: 100%; overflow: hidden; background: var(--board-bg); font-family: var(--font-body); color: white; -webkit-font-smoothing: antialiased; }

/* ═══════════════════════════════════════════
   PARTICLE CANVAS BACKGROUND
   ═══════════════════════════════════════════ */
#particle-canvas { position: fixed; inset: 0; z-index: 0; pointer-events: none; }

/* ═══════════════════════════════════════════
   ANIMATED LIGHT RAYS (STAGE LIGHTING)
   ═══════════════════════════════════════════ */
.light-rays { position: fixed; inset: 0; z-index: 0; overflow: hidden; pointer-events: none; opacity: 0; transition: opacity 2s ease; }
.light-rays.active { opacity: 1; }
.light-ray {
  position: absolute; top: -50%; width: 120px; height: 200%; 
  background: linear-gradient(180deg, transparent 0%, rgba(242,169,0,0.03) 30%, rgba(0,119,200,0.04) 50%, rgba(242,169,0,0.03) 70%, transparent 100%);
  transform-origin: top center; filter: blur(40px);
}
.light-ray:nth-child(1) { left: 5%; transform: rotate(15deg); animation: rayDrift1 18s ease-in-out infinite; }
.light-ray:nth-child(2) { left: 25%; transform: rotate(-8deg); animation: rayDrift2 22s ease-in-out infinite; animation-delay: -5s; }
.light-ray:nth-child(3) { left: 50%; transform: rotate(5deg); animation: rayDrift3 20s ease-in-out infinite; animation-delay: -10s; width: 160px; }
.light-ray:nth-child(4) { left: 70%; transform: rotate(-12deg); animation: rayDrift1 25s ease-in-out infinite; animation-delay: -7s; }
.light-ray:nth-child(5) { left: 90%; transform: rotate(10deg); animation: rayDrift2 19s ease-in-out infinite; animation-delay: -3s; }
@keyframes rayDrift1 { 0%,100% { transform: rotate(15deg) translateX(0); opacity: 0.6; } 50% { transform: rotate(5deg) translateX(40px); opacity: 1; } }
@keyframes rayDrift2 { 0%,100% { transform: rotate(-8deg) translateX(0); opacity: 0.5; } 50% { transform: rotate(-18deg) translateX(-30px); opacity: 1; } }
@keyframes rayDrift3 { 0%,100% { transform: rotate(5deg) translateX(0); opacity: 0.7; } 50% { transform: rotate(-5deg) translateX(50px); opacity: 1; } }

/* noise overlay */
body::after { content: ''; position: fixed; inset: 0; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E"); pointer-events: none; z-index: 0; }
#app { position: relative; z-index: 1; height: 100vh; display: flex; flex-direction: column; justify-content: center; padding-bottom: 8vh; }

/* ═══════════════════════════════════════════
   NORTHWELL "N" WATERMARK — Animated
   ═══════════════════════════════════════════ */
.northwell-watermark {
  position: fixed; bottom: 20px; left: 20px; z-index: 50; pointer-events: none;
  width: 64px; height: 64px; opacity: 0; transition: opacity 2s ease;
}
.northwell-watermark.active { opacity: 1; }
.northwell-watermark .n-outer {
  width: 64px; height: 64px; border-radius: 14px;
  background: linear-gradient(135deg, rgba(0,40,85,0.5), rgba(0,26,58,0.3));
  border: 1px solid rgba(255,255,255,0.08);
  backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
  display: flex; align-items: center; justify-content: center;
  position: relative; overflow: hidden;
  animation: watermarkPulse 6s ease-in-out infinite;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}
.northwell-watermark .n-outer::before {
  content: ''; position: absolute; inset: 0; border-radius: 14px;
  background: linear-gradient(135deg, transparent 30%, rgba(0,178,169,0.08) 50%, transparent 70%);
  animation: watermarkSheen 8s ease-in-out infinite;
}
.northwell-watermark .n-outer::after {
  content: ''; position: absolute; inset: -1px; border-radius: 14px;
  background: conic-gradient(from 0deg, transparent 0%, rgba(0,178,169,0.3) 10%, transparent 20%, transparent 50%, rgba(242,169,0,0.2) 60%, transparent 70%);
  animation: watermarkBorderSpin 12s linear infinite;
  mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  mask-composite: xor; -webkit-mask-composite: xor;
  padding: 1px;
}
.northwell-watermark .n-letter {
  font-family: var(--font-display); font-size: 2.2rem; font-weight: 700;
  background: linear-gradient(135deg, #FFFFFF 0%, var(--northwell-accent) 40%, var(--northwell-gold) 80%, #FFFFFF 100%);
  background-size: 300% auto;
  -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
  animation: watermarkLetterShimmer 6s ease-in-out infinite;
  filter: drop-shadow(0 2px 4px rgba(0,178,169,0.3));
}
@keyframes watermarkPulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.03); } }
@keyframes watermarkSheen { 0%,100% { opacity: 0.3; } 50% { opacity: 1; } }
@keyframes watermarkBorderSpin { to { transform: rotate(360deg); } }
@keyframes watermarkLetterShimmer { 0%,100% { background-position: 0% center; } 50% { background-position: 300% center; } }

/* ═══════════════════════════════════════════
   HEADER
   ═══════════════════════════════════════════ */
.header { text-align: center; padding: 10px 20px 8px; position: relative; flex-shrink: 0; }
.header::after { content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 80%; height: 1px; background: linear-gradient(90deg, transparent, rgba(0,178,169,0.4), rgba(242,169,0,0.4), transparent); }
.header h1 { font-family: var(--font-display); font-size: 2.8rem; font-weight: 700; letter-spacing: 6px; text-transform: uppercase; background: linear-gradient(135deg, #FFFFFF 0%, var(--northwell-gold) 50%, #FFFFFF 100%); background-size: 200% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; animation: shimmer 4s ease-in-out infinite; margin-bottom: 2px; }
@keyframes shimmer { 0%, 100% { background-position: 0% center; } 50% { background-position: 200% center; } }
.header .subtitle { font-family: var(--font-serif); font-size: 0.8rem; color: rgba(255,255,255,0.55); letter-spacing: 2.5px; font-style: italic; }

/* ═══════════════════════════════════════════
   PROGRESS INDICATOR (animated counter)
   ═══════════════════════════════════════════ */
.progress-container { position: fixed; top: 0; left: 0; right: 0; z-index: 100; height: 3px; background: rgba(255,255,255,0.05); }
.progress-fill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--northwell-accent), var(--northwell-gold), var(--northwell-accent)); background-size: 200% 100%; animation: progressShimmer 3s ease-in-out infinite; transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1); border-radius: 0 2px 2px 0; }
@keyframes progressShimmer { 0%,100% { background-position: 0% center; } 50% { background-position: 200% center; } }
.progress-label { position: fixed; top: 6px; right: 16px; z-index: 101; font-family: var(--font-display); font-size: 0.65rem; font-weight: 600; letter-spacing: 2px; text-transform: uppercase; color: rgba(255,255,255,0.25); transition: color 0.3s ease; }

/* ═══════════════════════════════════════════
   BOARD
   ═══════════════════════════════════════════ */
.board-container { flex: 0 1 auto; display: flex; align-items: center; justify-content: center; padding: 8px 20px 16px; min-height: 0; height: 82vh; max-height: 800px; perspective: 1200px; }

/* Animated gradient border wrapper */
.board-border-glow {
  position: relative; width: 100%; max-width: 1500px; height: 100%; max-height: 800px;
  padding: 3px; border-radius: 14px;
  background: conic-gradient(from var(--board-border-angle, 0deg),
    var(--northwell-gold), var(--northwell-accent), var(--northwell-sky),
    var(--northwell-blue), var(--northwell-gold), rgba(255,215,0,0.8),
    var(--northwell-accent), var(--northwell-gold));
  animation: rotateBorderGradient 6s linear infinite;
}
.board-border-glow::before {
  content: ''; position: absolute; inset: -4px; border-radius: 18px;
  background: inherit; filter: blur(18px); opacity: 0.35; z-index: -1;
}
@property --board-border-angle {
  syntax: '<angle>'; initial-value: 0deg; inherits: false;
}
@keyframes rotateBorderGradient {
  to { --board-border-angle: 360deg; }
}

.board { display: grid; grid-template-columns: repeat(5, 1fr); grid-template-rows: auto repeat(5, 1fr) auto; gap: 5px; width: 100%; height: 100%; background: var(--board-bg); border-radius: 11px; padding: 5px; }

/* Board entrance cascade */
.board .category-header, .board .cell, .board .final-jeopardy-btn {
  opacity: 0; transform: translateY(30px) scale(0.9);
}
.board.revealed .category-header, .board.revealed .cell, .board.revealed .final-jeopardy-btn {
  animation: cellCascadeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
}
@keyframes cellCascadeIn {
  0% { opacity: 0; transform: translateY(30px) scale(0.9); }
  100% { opacity: 1; transform: translateY(0) scale(1); }
}

/* Category header with typewriter support */
.category-header { background: linear-gradient(180deg, var(--northwell-blue) 0%, var(--northwell-navy) 100%); border-radius: var(--radius) var(--radius) 0 0; display: flex; align-items: center; justify-content: center; text-align: center; padding: 10px 6px; border-bottom: 2px solid var(--northwell-gold); position: relative; overflow: hidden; }
.category-header::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, transparent, var(--northwell-accent), transparent); }
.category-header h2 { font-family: var(--font-display); font-size: 1.1rem; font-weight: 600; letter-spacing: 2px; text-transform: uppercase; color: white; line-height: 1.2; text-shadow: 0 2px 4px rgba(0,0,0,0.4); }

/* Typewriter cursor blink */
.typewriter-cursor {
  display: inline-block; width: 2px; height: 1em; background: var(--northwell-gold);
  margin-left: 2px; vertical-align: middle;
  animation: cursorBlink 0.6s step-end infinite;
}
@keyframes cursorBlink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

/* ═══════════════════════════════════════════
   CELLS with 3D FLIP + SPOTLIGHT
   ═══════════════════════════════════════════ */
.cell { background: linear-gradient(145deg, var(--cell-bg), #001D42); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative; overflow: hidden; transition: var(--transition); border: 1px solid rgba(255,255,255,0.06); transform-style: preserve-3d; }
.cell::before { content: ''; position: absolute; inset: 0; background: linear-gradient(135deg, rgba(255,255,255,0.04) 0%, transparent 50%); transition: var(--transition); }

/* Mouse spotlight overlay */
.cell .cell-spotlight {
  position: absolute; inset: 0; pointer-events: none; opacity: 0;
  transition: opacity 0.3s ease;
  background: radial-gradient(circle 80px at var(--mouse-x, 50%) var(--mouse-y, 50%), rgba(242,169,0,0.12) 0%, rgba(0,178,169,0.04) 40%, transparent 70%);
}
.cell:hover:not(.used):not(.flipping) .cell-spotlight { opacity: 1; }

.cell:hover:not(.used):not(.flipping) { background: linear-gradient(145deg, var(--cell-hover), #002855); transform: scale(1.03) translateZ(10px); z-index: 2; border-color: var(--northwell-gold); box-shadow: 0 0 20px rgba(242,169,0,0.2), 0 8px 25px rgba(0,0,0,0.4); }
.cell:hover:not(.used):not(.flipping)::before { background: linear-gradient(135deg, rgba(242,169,0,0.08) 0%, transparent 50%); }
.cell .dollar { font-family: var(--font-display); font-size: 2.2rem; font-weight: 700; color: var(--northwell-gold); text-shadow: 0 2px 8px rgba(242,169,0,0.3); transition: var(--transition); position: relative; z-index: 1; }
.cell:hover:not(.used):not(.flipping) .dollar { text-shadow: 0 2px 16px rgba(242,169,0,0.5); transform: scale(1.08); }

/* 3D Flip animation */
.cell.flipping {
  animation: cellFlipOut 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
  z-index: 50; pointer-events: none;
}
@keyframes cellFlipOut {
  0% { transform: perspective(800px) rotateY(0deg) scale(1); opacity: 1; }
  40% { transform: perspective(800px) rotateY(90deg) scale(1.15); opacity: 0.6; }
  70% { transform: perspective(800px) rotateY(180deg) scale(1.3); opacity: 0; }
  100% { transform: perspective(800px) rotateY(180deg) scale(1); opacity: 0; }
}

/* Used cell with animated checkmark */
.cell.used { background: var(--cell-used); cursor: default; border-color: transparent; overflow: hidden; }
.cell.used::before { display: none; }
.cell.used .dollar { opacity: 0; }
.cell.used::after { 
  content: ''; position: absolute; width: 0; height: 0; border-radius: 50%; 
  background: radial-gradient(circle, rgba(0,178,169,0.15) 0%, transparent 70%);
  animation: usedReveal 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
}
@keyframes usedReveal {
  0% { width: 0; height: 0; opacity: 0; }
  50% { opacity: 1; }
  100% { width: 60px; height: 60px; opacity: 1; }
}
.cell.used .checkmark { 
  position: absolute; z-index: 2; opacity: 0; 
  animation: checkDraw 0.5s ease 0.2s forwards;
}
@keyframes checkDraw {
  0% { opacity: 0; transform: scale(0) rotate(-45deg); }
  50% { opacity: 1; transform: scale(1.3) rotate(0deg); }
  100% { opacity: 0.3; transform: scale(1) rotate(0deg); }
}

.final-jeopardy-btn { grid-column: 1 / -1; background: linear-gradient(135deg, var(--northwell-navy) 0%, #001030 100%); border-radius: 0 0 var(--radius) var(--radius); display: flex; align-items: center; justify-content: center; cursor: pointer; padding: 12px; border: 1px solid rgba(242,169,0,0.2); transition: var(--transition); position: relative; overflow: hidden; }
.final-jeopardy-btn::before { content: ''; position: absolute; inset: 0; background: linear-gradient(90deg, transparent, rgba(242,169,0,0.05), transparent); animation: fjSweep 3s ease-in-out infinite; }
@keyframes fjSweep { 0%, 100% { transform: translateX(-100%); } 50% { transform: translateX(100%); } }
.final-jeopardy-btn:hover { border-color: var(--northwell-gold); box-shadow: 0 0 30px rgba(242,169,0,0.15); }
.final-jeopardy-btn span { font-family: var(--font-display); font-size: 1.15rem; font-weight: 700; letter-spacing: 6px; text-transform: uppercase; background: linear-gradient(135deg, var(--northwell-gold), #FFD700, var(--northwell-gold)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.final-jeopardy-btn.used { opacity: 0.3; cursor: default; pointer-events: none; }

/* ═══════════════════════════════════════════
   MODALS — GLASSMORPHISM + TRANSITIONS
   ═══════════════════════════════════════════ */
.modal-overlay { 
  position: fixed; inset: 0; z-index: 1000; display: none; align-items: center; justify-content: center; 
  background: rgba(0,6,18,0.85); backdrop-filter: blur(30px) saturate(1.4); -webkit-backdrop-filter: blur(30px) saturate(1.4); 
  opacity: 0; transition: opacity 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}
.modal-overlay.active { display: flex; opacity: 1; }
.modal-overlay.fade-out { opacity: 0; transition: opacity 0.4s ease; }

.clue-modal, .fj-modal { 
  width: 90%; max-width: 850px; position: relative; text-align: center; 
  animation: modalIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
  background: linear-gradient(135deg, rgba(0,40,85,0.4) 0%, rgba(0,20,50,0.3) 100%);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 24px; padding: 50px 40px;
  box-shadow: 0 32px 80px rgba(0,0,0,0.5), 0 0 1px rgba(255,255,255,0.1), inset 0 1px 0 rgba(255,255,255,0.05);
  backdrop-filter: blur(40px) saturate(1.3);
  -webkit-backdrop-filter: blur(40px) saturate(1.3);
}
/* Glass refraction accent */
.clue-modal::before, .fj-modal::before {
  content: ''; position: absolute; top: -1px; left: 30px; right: 30px; height: 1px;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), rgba(242,169,0,0.15), rgba(255,255,255,0.2), transparent);
  border-radius: 50%;
}
.clue-modal::after, .fj-modal::after {
  content: ''; position: absolute; inset: 0; border-radius: 24px; pointer-events: none;
  background: radial-gradient(ellipse at 30% 0%, rgba(78,168,222,0.06) 0%, transparent 50%);
}
@keyframes modalIn { from { transform: scale(0.85) translateY(30px); opacity: 0; } to { transform: scale(1) translateY(0); opacity: 1; } }

.clue-category-badge { display: inline-block; font-family: var(--font-display); font-size: 0.8rem; font-weight: 600; letter-spacing: 3px; text-transform: uppercase; color: var(--northwell-accent); margin-bottom: 8px; padding: 4px 16px; border: 1px solid rgba(0,178,169,0.3); border-radius: 50px; background: rgba(0,178,169,0.08); position: relative; z-index: 1; }
.clue-value-display { font-family: var(--font-display); font-size: 3.5rem; font-weight: 700; color: var(--northwell-gold); text-shadow: 0 4px 20px rgba(242,169,0,0.3); margin-bottom: 20px; line-height: 1; position: relative; z-index: 1; }
.clue-question { font-family: var(--font-serif); font-size: 1.75rem; line-height: 1.5; color: white; text-align: center; max-width: 700px; margin: 0 auto 30px; text-shadow: 0 2px 8px rgba(0,0,0,0.3); position: relative; z-index: 1; }
.reveal-btn { display: block; margin: 0 auto; padding: 16px 48px; font-family: var(--font-display); font-size: 1rem; font-weight: 600; letter-spacing: 3px; text-transform: uppercase; color: white; background: linear-gradient(135deg, var(--northwell-blue), var(--northwell-sky)); border: 1px solid rgba(255,255,255,0.15); border-radius: 60px; cursor: pointer; transition: var(--transition); position: relative; z-index: 1; }
.reveal-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(0,119,200,0.4); border-color: var(--northwell-light); }
.clue-answer { display: none; text-align: center; animation: answerReveal 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; position: relative; z-index: 1; }
@keyframes answerReveal { from { transform: translateY(15px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
.clue-answer .answer-label { font-family: var(--font-display); font-size: 0.75rem; font-weight: 600; letter-spacing: 4px; text-transform: uppercase; color: var(--northwell-accent); margin-bottom: 10px; }
.clue-answer .answer-text { font-family: var(--font-serif); font-size: 1.65rem; color: var(--northwell-gold); line-height: 1.4; text-shadow: 0 2px 12px rgba(242,169,0,0.2); animation: answerGlow 1.5s ease forwards; }
@keyframes answerGlow { 0% { text-shadow: 0 0 40px rgba(242,169,0,0.8), 0 0 80px rgba(242,169,0,0.4); } 100% { text-shadow: 0 2px 12px rgba(242,169,0,0.2); } }
.close-modal { position: absolute; top: 16px; right: 16px; width: 40px; height: 40px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,40,85,0.4); color: white; font-size: 1.2rem; cursor: pointer; transition: var(--transition); display: flex; align-items: center; justify-content: center; z-index: 5; backdrop-filter: blur(10px); }
.close-modal:hover { background: rgba(231,76,111,0.6); border-color: rgba(231,76,111,0.8); transform: rotate(90deg); }
.fj-title { font-family: var(--font-display); font-size: 3.2rem; font-weight: 700; letter-spacing: 8px; text-transform: uppercase; background: linear-gradient(135deg, var(--northwell-gold), #FFD700, var(--northwell-gold)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 30px; animation: shimmer 3s ease-in-out infinite; background-size: 200% auto; position: relative; z-index: 1; }

/* ═══════════════════════════════════════════
   DRAMATIC TIMER
   ═══════════════════════════════════════════ */
.timer-bar-container { width: 100%; max-width: 500px; margin: 25px auto 0; display: none; position: relative; z-index: 1; }
.timer-bar-container.active { display: block; }
.timer-controls { display: flex; align-items: center; gap: 12px; justify-content: center; margin-bottom: 10px; }
.timer-toggle { padding: 6px 20px; border-radius: 50px; border: 1px solid rgba(255,255,255,0.15); background: rgba(0,119,200,0.3); color: white; font-family: var(--font-display); font-size: 0.7rem; font-weight: 600; letter-spacing: 2px; text-transform: uppercase; cursor: pointer; transition: var(--transition); backdrop-filter: blur(10px); }
.timer-toggle:hover { background: rgba(0,119,200,0.6); }
.timer-toggle.running { background: var(--wrong-red); border-color: var(--wrong-red); }
.timer-display { font-family: var(--font-display); font-size: 1.6rem; font-weight: 700; color: white; min-width: 40px; text-align: center; transition: all 0.3s ease; }
.timer-display.urgent { color: var(--wrong-red); font-size: 2.4rem; text-shadow: 0 0 20px rgba(231,76,111,0.6); }
.timer-display.critical { color: #FF4444; font-size: 3.2rem; text-shadow: 0 0 30px rgba(255,68,68,0.8), 0 0 60px rgba(255,68,68,0.4); animation: timerPulse 0.5s ease-in-out infinite; }
@keyframes timerPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.15); } }
.timer-track { width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 6px; overflow: hidden; }
.timer-fill { height: 100%; background: linear-gradient(90deg, var(--northwell-accent), var(--northwell-gold)); border-radius: 6px; width: 100%; transition: width 1s linear; }
.timer-fill.danger { background: linear-gradient(90deg, var(--wrong-red), #FF6B6B); animation: barPulse 0.6s ease-in-out infinite; }
@keyframes barPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

.screen-urgency { position: fixed; inset: 0; pointer-events: none; z-index: 999; opacity: 0; transition: opacity 0.5s ease; background: radial-gradient(ellipse at center, transparent 40%, rgba(231,76,111,0.25) 100%); }
.screen-urgency.active { opacity: 1; }
.screen-urgency.critical-pulse { background: rgba(200,20,50,0.18); animation: fullScreenPulse 0.6s ease-in-out infinite; }
@keyframes fullScreenPulse { 0%, 100% { background: rgba(200,20,50,0.06); } 50% { background: rgba(200,20,50,0.22); } }

/* TIMES UP */
.times-up-overlay { position: fixed; inset: 0; z-index: 1500; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); flex-direction: column; cursor: pointer; }
.times-up-overlay.active { display: flex; animation: timesUpIn 0.3s ease forwards; }
@keyframes timesUpIn { from { opacity: 0; } to { opacity: 1; } }
.times-up-text { font-family: var(--font-display); font-size: 5rem; font-weight: 700; letter-spacing: 8px; text-transform: uppercase; color: var(--wrong-red); text-shadow: 0 0 40px rgba(231,76,111,0.6), 0 0 80px rgba(231,76,111,0.3); animation: timesUpBounce 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards; }
@keyframes timesUpBounce { from { transform: scale(0.3); opacity: 0; } 60% { transform: scale(1.15); } to { transform: scale(1); opacity: 1; } }
.times-up-sub { font-family: var(--font-serif); font-style: italic; font-size: 1rem; color: rgba(255,255,255,0.4); margin-top: 10px; }

/* DAILY DOUBLE */
.daily-double-splash { position: fixed; inset: 0; z-index: 2000; display: none; align-items: center; justify-content: center; background: rgba(0,5,15,0.97); cursor: pointer; overflow: hidden; }
.daily-double-splash.active { display: flex; }
.dd-particles { position: absolute; inset: 0; overflow: hidden; }
.dd-particle { position: absolute; border-radius: 50%; }
.dd-content { text-align: center; z-index: 1; animation: ddEntrance 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards; }
@keyframes ddEntrance { 0% { transform: scale(0.1) rotate(-20deg); opacity: 0; } 50% { transform: scale(1.3) rotate(5deg); opacity: 1; } 70% { transform: scale(0.9) rotate(-2deg); } 100% { transform: scale(1) rotate(0deg); opacity: 1; } }
.dd-stars { font-size: 3rem; margin-bottom: 10px; display: block; }
.dd-star-item { display: inline-block; animation: starExplode 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards; opacity: 0; }
@keyframes starExplode { from { transform: scale(0) rotate(0deg); opacity: 0; } to { transform: scale(1) rotate(720deg); opacity: 1; } }
.dd-text { font-family: var(--font-display); font-size: 5.5rem; font-weight: 700; letter-spacing: 8px; text-transform: uppercase; background: linear-gradient(135deg, #F2A900, #FFD700, #FFF8DC, #FFD700, #F2A900); background-size: 300% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; animation: ddShimmer 1.5s ease-in-out infinite, ddShake 0.5s ease-in-out 0.8s; filter: drop-shadow(0 0 30px rgba(242,169,0,0.4)); }
@keyframes ddShimmer { 0%, 100% { background-position: 0% center; } 50% { background-position: 300% center; } }
@keyframes ddShake { 0%, 100% { transform: translateX(0); } 20% { transform: translateX(-8px) rotate(-1deg); } 40% { transform: translateX(8px) rotate(1deg); } 60% { transform: translateX(-4px); } 80% { transform: translateX(4px); } }
.dd-subtitle { font-family: var(--font-serif); font-style: italic; font-size: 1.1rem; color: rgba(255,255,255,0.5); margin-top: 15px; animation: fadeInUp 0.5s ease 1s forwards; opacity: 0; }
@keyframes fadeInUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
.screen-shake { animation: screenShake 0.6s ease-in-out; }
@keyframes screenShake { 0%, 100% { transform: translate(0,0); } 10% { transform: translate(-5px,-3px); } 20% { transform: translate(5px,3px); } 30% { transform: translate(-4px,2px); } 40% { transform: translate(4px,-2px); } 50% { transform: translate(-3px,3px); } 60% { transform: translate(3px,-1px); } 70% { transform: translate(-2px,1px); } }
.dd-burst { position: absolute; border-radius: 50%; border: 3px solid var(--northwell-gold); top: 50%; left: 50%; transform: translate(-50%,-50%); animation: burstRing 1s ease-out forwards; }
@keyframes burstRing { 0% { width: 10px; height: 10px; opacity: 1; border-width: 4px; } 100% { width: 800px; height: 800px; opacity: 0; border-width: 1px; } }

/* CONFETTI */
#confetti-canvas { position: fixed; inset: 0; z-index: 4000; pointer-events: none; }

/* ═══════════════════════════════════════════
   CINEMATIC SPLASH SCREEN
   ═══════════════════════════════════════════ */
.splash-screen { position: fixed; inset: 0; z-index: 3000; display: flex; align-items: center; justify-content: center; background: #000810; flex-direction: column; cursor: pointer; overflow: hidden; }
.splash-screen::before { content: ''; position: absolute; inset: 0; background: radial-gradient(ellipse at 50% 50%, rgba(0,40,85,0.3) 0%, transparent 60%); }
.splash-screen.hidden { animation: splashOut 1s ease forwards; pointer-events: none; }
@keyframes splashOut { 
  0% { opacity: 1; }
  60% { opacity: 1; transform: scale(1); }
  100% { opacity: 0; transform: scale(1.15); }
}

.splash-title-container { position: relative; z-index: 1; perspective: 1000px; margin-bottom: 8px; }
.splash-letter {
  display: inline-block; font-family: var(--font-display); font-size: 8rem; font-weight: 700;
  letter-spacing: 8px; text-transform: uppercase;
  color: transparent; 
  background: linear-gradient(135deg, #FFFFFF, var(--northwell-gold), #FFFFFF);
  background-size: 300% auto;
  -webkit-background-clip: text; background-clip: text;
  opacity: 0; transform: perspective(800px) rotateX(90deg) translateY(60px) scale(0.5);
  animation: letterReveal 0.7s cubic-bezier(0.16, 1, 0.3, 1) forwards;
  filter: blur(8px);
}
@keyframes letterReveal {
  0% { opacity: 0; transform: perspective(800px) rotateX(90deg) translateY(60px) scale(0.5); filter: blur(8px); }
  60% { opacity: 1; transform: perspective(800px) rotateX(-10deg) translateY(-5px) scale(1.05); filter: blur(0px); }
  80% { transform: perspective(800px) rotateX(3deg) translateY(2px) scale(0.98); }
  100% { opacity: 1; transform: perspective(800px) rotateX(0deg) translateY(0) scale(1); filter: blur(0px); }
}

.splash-title-container::after {
  content: ''; position: absolute; top: 0; left: -100%; width: 60%; height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), rgba(242,169,0,0.2), transparent);
  animation: lightSweep 1.2s ease 1.8s forwards; opacity: 0; pointer-events: none;
}
@keyframes lightSweep {
  0% { left: -60%; opacity: 0; }
  10% { opacity: 1; }
  100% { left: 120%; opacity: 0; }
}

.splash-sub { font-family: var(--font-serif); font-style: italic; font-size: 1.1rem; color: rgba(255,255,255,0); letter-spacing: 3px; margin-bottom: 50px; position: relative; z-index: 1; text-align: center; animation: subtitleFadeIn 0.8s ease 1.6s forwards; }
@keyframes subtitleFadeIn { from { color: rgba(255,255,255,0); transform: translateY(10px); } to { color: rgba(255,255,255,0.5); transform: translateY(0); } }
.splash-start { font-family: var(--font-display); font-size: 0.8rem; letter-spacing: 4px; text-transform: uppercase; color: rgba(255,255,255,0); animation: startPulse 2s ease-in-out 2.5s infinite, startFadeIn 0.5s ease 2.5s forwards; position: relative; z-index: 1; }
@keyframes startFadeIn { to { color: rgba(255,255,255,0.4); } }
@keyframes startPulse { 0%, 100% { opacity: 0.3; } 50% { opacity: 0.8; } }
.splash-brand { position: absolute; bottom: 30px; font-family: var(--font-body); font-size: 0.7rem; color: rgba(255,255,255,0.15); letter-spacing: 2px; z-index: 1; }

/* Splash particles */
.splash-particles { position: absolute; inset: 0; z-index: 0; overflow: hidden; }
.splash-particle {
  position: absolute; width: 3px; height: 3px; border-radius: 50%;
  background: var(--northwell-gold); opacity: 0;
  animation: splashParticleDrift 6s ease-in-out infinite;
}
@keyframes splashParticleDrift {
  0% { opacity: 0; transform: translateY(0) scale(0); }
  20% { opacity: 0.6; transform: translateY(-30px) scale(1); }
  80% { opacity: 0.3; }
  100% { opacity: 0; transform: translateY(-200px) scale(0.5); }
}

/* ═══════════════════════════════════════════
   SETTINGS
   ═══════════════════════════════════════════ */
.settings-btn { position: fixed; bottom: 12px; right: 12px; z-index: 500; width: 36px; height: 36px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,40,85,0.6); color: rgba(255,255,255,0.5); font-size: 1rem; cursor: pointer; transition: var(--transition); display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
.settings-btn:hover { color: white; transform: rotate(90deg); border-color: rgba(255,255,255,0.3); }
.sound-group { position: fixed; bottom: 12px; right: 56px; z-index: 500; display: flex; align-items: center; gap: 0; }
.sound-toggle { width: 36px; height: 36px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,40,85,0.6); color: rgba(255,255,255,0.5); font-size: 0.9rem; cursor: pointer; transition: var(--transition); display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); position: relative; z-index: 2; }
.sound-toggle:hover { color: white; }
.volume-slider-wrap {
  position: absolute; bottom: 44px; left: 50%; transform: translateX(-50%);
  background: linear-gradient(135deg, rgba(0,40,85,0.92), rgba(0,26,58,0.92));
  border: 1px solid rgba(255,255,255,0.1); border-radius: 12px;
  padding: 14px 10px; backdrop-filter: blur(30px); box-shadow: 0 8px 32px rgba(0,0,0,0.45);
  display: none; flex-direction: column; align-items: center; gap: 8px; width: 44px;
}
.volume-slider-wrap.active { display: flex; }
.volume-slider-wrap input[type="range"] {
  -webkit-appearance: none; appearance: none;
  width: 90px; height: 4px; border-radius: 4px;
  background: linear-gradient(90deg, var(--northwell-accent), var(--northwell-gold));
  outline: none; cursor: pointer;
  transform: rotate(-90deg); transform-origin: center center;
  margin: 36px 0;
}
.volume-slider-wrap input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none; appearance: none;
  width: 16px; height: 16px; border-radius: 50%;
  background: white; border: 2px solid var(--northwell-gold);
  box-shadow: 0 2px 8px rgba(0,0,0,0.3); cursor: pointer;
}
.volume-slider-wrap input[type="range"]::-moz-range-thumb {
  width: 16px; height: 16px; border-radius: 50%;
  background: white; border: 2px solid var(--northwell-gold);
  box-shadow: 0 2px 8px rgba(0,0,0,0.3); cursor: pointer;
}
.volume-pct {
  font-family: var(--font-display); font-size: 0.6rem; font-weight: 600;
  color: var(--northwell-gold); letter-spacing: 1px;
}
.sound-mute-btn {
  width: 28px; height: 28px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.15);
  background: rgba(0,40,85,0.6); color: rgba(255,255,255,0.6); font-size: 0.75rem;
  cursor: pointer; transition: var(--transition); display: flex; align-items: center; justify-content: center;
}
.sound-mute-btn:hover { color: white; background: rgba(231,76,111,0.4); border-color: var(--wrong-red); }
.settings-panel { position: fixed; bottom: 55px; right: 12px; z-index: 500; background: linear-gradient(135deg, rgba(0,40,85,0.9), rgba(0,26,58,0.9)); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 16px; width: 220px; backdrop-filter: blur(30px); display: none; box-shadow: 0 8px 32px rgba(0,0,0,0.45); }
.settings-panel.active { display: block; }
.settings-panel h3 { font-family: var(--font-display); font-size: 0.75rem; font-weight: 600; letter-spacing: 2px; text-transform: uppercase; color: var(--northwell-accent); margin-bottom: 12px; }
.setting-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
.setting-row label { font-size: 0.78rem; color: rgba(255,255,255,0.7); }
.setting-row input[type="number"] { width: 50px; padding: 3px 6px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.15); background: rgba(0,20,50,0.6); color: white; font-family: var(--font-body); font-size: 0.8rem; text-align: center; outline: none; }
.reset-btn { width: 100%; padding: 8px; margin-top: 8px; border-radius: 8px; border: 1px solid rgba(231,76,111,0.3); background: rgba(231,76,111,0.15); color: var(--wrong-red); font-family: var(--font-display); font-size: 0.7rem; font-weight: 600; letter-spacing: 2px; text-transform: uppercase; cursor: pointer; transition: var(--transition); }
.reset-btn:hover { background: rgba(231,76,111,0.3); border-color: var(--wrong-red); }

/* ═══════════════════════════════════════════
   VICTORY CELEBRATION SCREEN
   ═══════════════════════════════════════════ */
.victory-overlay {
  position: fixed; inset: 0; z-index: 5000; display: none; align-items: center; justify-content: center;
  background: rgba(0,5,15,0.95); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
  flex-direction: column; cursor: pointer; overflow: hidden;
}
.victory-overlay.active { display: flex; }
.victory-particles { position: absolute; inset: 0; overflow: hidden; z-index: 0; }
.victory-content { text-align: center; z-index: 2; animation: victoryEntrance 1s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
@keyframes victoryEntrance {
  0% { transform: scale(0.3) translateY(60px); opacity: 0; }
  60% { transform: scale(1.08) translateY(-10px); opacity: 1; }
  100% { transform: scale(1) translateY(0); opacity: 1; }
}
.victory-crown { font-size: 5rem; margin-bottom: 10px; animation: crownBounce 1.5s ease-in-out infinite; display: block; }
@keyframes crownBounce { 0%,100% { transform: translateY(0) rotate(0deg); } 25% { transform: translateY(-12px) rotate(-3deg); } 75% { transform: translateY(-8px) rotate(3deg); } }
.victory-title {
  font-family: var(--font-display); font-size: 5rem; font-weight: 700; letter-spacing: 6px; text-transform: uppercase;
  background: linear-gradient(135deg, var(--northwell-gold), #FFD700, #FFF8DC, #FFD700, var(--northwell-gold));
  background-size: 300% auto; -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
  animation: ddShimmer 2s ease-in-out infinite;
  filter: drop-shadow(0 0 40px rgba(242,169,0,0.5));
  margin-bottom: 30px;
}
.victory-stats {
  display: flex; gap: 40px; justify-content: center; margin-bottom: 30px;
}
.victory-stat {
  text-align: center; opacity: 0; animation: statReveal 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
}
.victory-stat:nth-child(1) { animation-delay: 0.5s; }
.victory-stat:nth-child(2) { animation-delay: 0.7s; }
.victory-stat:nth-child(3) { animation-delay: 0.9s; }
@keyframes statReveal { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
.victory-stat-number {
  font-family: var(--font-display); font-size: 3.5rem; font-weight: 700; color: var(--northwell-gold);
  text-shadow: 0 4px 20px rgba(242,169,0,0.3);
}
.victory-stat-label {
  font-family: var(--font-serif); font-size: 0.85rem; font-style: italic;
  color: rgba(255,255,255,0.5); letter-spacing: 1px; margin-top: 4px;
}
.victory-subtitle {
  font-family: var(--font-serif); font-style: italic; font-size: 1.1rem;
  color: rgba(255,255,255,0.4); opacity: 0; animation: fadeInUp 0.5s ease 1.2s forwards;
}

/* ═══════════════════════════════════════════
   FULLSCREEN BUTTON
   ═══════════════════════════════════════════ */
.fullscreen-btn {
  position: fixed; bottom: 12px; right: 56px; z-index: 500;
  width: 36px; height: 36px; border-radius: 50%;
  border: 1px solid rgba(255,255,255,0.1); background: rgba(0,40,85,0.6);
  color: rgba(255,255,255,0.5); font-size: 0.85rem; cursor: pointer;
  transition: var(--transition); display: flex; align-items: center; justify-content: center;
  backdrop-filter: blur(10px);
}
.fullscreen-btn:hover { color: white; border-color: rgba(255,255,255,0.3); transform: scale(1.1); }

/* ═══════════════════════════════════════════
   KEYBOARD HINTS TOOLTIP
   ═══════════════════════════════════════════ */
.keyboard-hints {
  position: fixed; bottom: 55px; right: 12px; z-index: 500;
  background: linear-gradient(135deg, rgba(0,40,85,0.9), rgba(0,26,58,0.9));
  border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 12px 16px;
  backdrop-filter: blur(30px); box-shadow: 0 8px 32px rgba(0,0,0,0.45);
  font-family: var(--font-body); font-size: 0.7rem; color: rgba(255,255,255,0.5);
  display: none; line-height: 1.8;
}
.keyboard-hints.active { display: block; }
.keyboard-hints kbd {
  display: inline-block; padding: 2px 7px; border-radius: 4px;
  background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.15);
  font-family: var(--font-display); font-size: 0.65rem; font-weight: 600;
  color: var(--northwell-gold); margin: 0 2px; letter-spacing: 1px;
}
.kb-hint-btn {
  position: fixed; bottom: 12px; right: 100px; z-index: 500;
  width: 36px; height: 36px; border-radius: 50%;
  border: 1px solid rgba(255,255,255,0.1); background: rgba(0,40,85,0.6);
  color: rgba(255,255,255,0.5); font-size: 0.75rem; cursor: pointer;
  transition: var(--transition); display: flex; align-items: center; justify-content: center;
  backdrop-filter: blur(10px); font-family: var(--font-display); font-weight: 700;
}
.kb-hint-btn:hover { color: white; border-color: rgba(255,255,255,0.3); }

/* Lo-Fi Music Button */
.lofi-btn {
  width: 36px; height: 36px; border-radius: 50%;
  border: 1px solid rgba(255,255,255,0.1); background: rgba(0,40,85,0.6);
  color: rgba(255,255,255,0.5); font-size: 0.85rem; cursor: pointer;
  transition: var(--transition); display: flex; align-items: center; justify-content: center;
  backdrop-filter: blur(10px); position: relative; z-index: 2;
}
.lofi-btn:hover { color: white; border-color: rgba(255,255,255,0.3); }
.lofi-btn.playing { color: var(--northwell-gold); border-color: rgba(242,169,0,0.4); background: rgba(242,169,0,0.12); animation: lofiPulse 3s ease-in-out infinite; }
@keyframes lofiPulse { 0%,100% { box-shadow: none; } 50% { box-shadow: 0 0 12px 2px rgba(242,169,0,0.15); } }
.lofi-vol-wrap {
  position: absolute; bottom: 44px; left: 50%; transform: translateX(-50%);
  background: linear-gradient(135deg, rgba(0,40,85,0.92), rgba(0,26,58,0.92));
  border: 1px solid rgba(255,255,255,0.1); border-radius: 12px;
  padding: 14px 10px; backdrop-filter: blur(30px); box-shadow: 0 8px 32px rgba(0,0,0,0.45);
  display: none; flex-direction: column; align-items: center; gap: 8px; width: 44px;
}
.lofi-vol-wrap.active { display: flex; }
.lofi-vol-wrap input[type="range"] {
  -webkit-appearance: none; appearance: none;
  width: 90px; height: 4px; border-radius: 4px;
  background: linear-gradient(90deg, var(--northwell-accent), var(--northwell-gold));
  outline: none; cursor: pointer;
  transform: rotate(-90deg); transform-origin: center center;
  margin: 36px 0;
}
.lofi-vol-wrap input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none; appearance: none;
  width: 16px; height: 16px; border-radius: 50%;
  background: white; border: 2px solid var(--northwell-gold);
  box-shadow: 0 2px 8px rgba(0,0,0,0.3); cursor: pointer;
}
.lofi-vol-pct {
  font-family: var(--font-display); font-size: 0.6rem; font-weight: 600;
  color: var(--northwell-gold); letter-spacing: 1px;
}

/* T-Swift Button */
.tswift-btn {
  position: fixed; bottom: 12px; right: 188px; z-index: 500;
  width: 36px; height: 36px; border-radius: 50%;
  border: 1px solid rgba(255,180,200,0.2); background: rgba(255,180,200,0.08);
  color: rgba(255,200,215,0.6); font-size: 0.75rem; cursor: pointer;
  transition: var(--transition); display: flex; align-items: center; justify-content: center;
  backdrop-filter: blur(10px); text-decoration: none;
}
.tswift-btn:hover { color: #ffc8d9; border-color: rgba(255,180,200,0.5); background: rgba(255,180,200,0.18); transform: scale(1.1); }

@media (max-width: 900px) {
  .header h1 { font-size: 1.8rem; letter-spacing: 4px; }
  .category-header h2 { font-size: 0.7rem; }
  .cell .dollar { font-size: 1.3rem; }
  .clue-value-display { font-size: 2.5rem; }
  .clue-question { font-size: 1.3rem; }
  .dd-text { font-size: 3rem; }
  .times-up-text { font-size: 3rem; }
  .victory-title { font-size: 3rem; letter-spacing: 4px; }
  .victory-stat-number { font-size: 2.2rem; }
  .victory-stats { gap: 20px; }
  .victory-crown { font-size: 3rem; }
  .splash-letter { font-size: 4rem; }
  .northwell-watermark { width: 48px; height: 48px; }
  .northwell-watermark .n-outer { width: 48px; height: 48px; border-radius: 10px; }
  .northwell-watermark .n-letter { font-size: 1.6rem; }
}
</style>
</head>
<body>

<!-- SPLASH SCREEN — CINEMATIC -->
<div class="splash-screen" id="splash" onclick="dismissSplash()">
  <div class="splash-particles" id="splash-particles"></div>
  <div class="splash-title-container" id="splash-title"></div>
  <div class="splash-sub">CCC Retreat &nbsp;&bull;&nbsp; Northwell Health &nbsp;&bull;&nbsp; Long Island Jewish Medical Center</div>
  <div class="splash-start">Click anywhere to begin</div>
  <div class="splash-brand">NORTHWELL HEALTH &mdash; LONG ISLAND JEWISH MEDICAL CENTER</div>
</div>

<!-- NORTHWELL "N" WATERMARK -->
<div class="northwell-watermark" id="northwell-watermark">
  <div class="n-outer">
    <span class="n-letter">N</span>
  </div>
</div>

<canvas id="particle-canvas"></canvas>
<canvas id="confetti-canvas"></canvas>

<!-- LIGHT RAYS -->
<div class="light-rays" id="light-rays">
  <div class="light-ray"></div>
  <div class="light-ray"></div>
  <div class="light-ray"></div>
  <div class="light-ray"></div>
  <div class="light-ray"></div>
</div>

<!-- PROGRESS BAR -->
<div class="progress-container" id="progress-container">
  <div class="progress-fill" id="progress-fill"></div>
</div>
<div class="progress-label" id="progress-label">0 / 25</div>

<div class="screen-urgency" id="screen-urgency"></div>
<div class="times-up-overlay" id="times-up-overlay" onclick="dismissTimesUp()">
  <div class="times-up-text">TIME'S UP!</div>
  <div class="times-up-sub">Click to continue</div>
</div>

<div id="app">
  <header class="header">
    <h1>JEOPARDY!</h1>
    <div class="subtitle">CCC Retreat &nbsp;&bull;&nbsp; Northwell Health &nbsp;&bull;&nbsp; Long Island Jewish Medical Center</div>
  </header>
  <div class="board-container">
    <div class="board-border-glow">
      <div class="board" id="board"></div>
    </div>
  </div>
</div>

<!-- CLUE MODAL -->
<div class="modal-overlay" id="clue-overlay" onclick="handleOverlayClick(event)">
  <div class="clue-modal" id="clue-modal">
    <button class="close-modal" onclick="closeClue()">&times;</button>
    <div class="clue-category-badge" id="clue-cat"></div>
    <div class="clue-value-display" id="clue-val"></div>
    <div class="clue-question" id="clue-q"></div>
    <button class="reveal-btn" id="reveal-btn" onclick="revealAnswer()">Reveal Answer</button>
    <div class="clue-answer" id="clue-answer">
      <div class="answer-label">Answer</div>
      <div class="answer-text" id="clue-a"></div>
    </div>
    <div class="timer-bar-container" id="timer-bar-container">
      <div class="timer-controls">
        <button class="timer-toggle" id="timer-toggle" onclick="toggleTimer()">Start Timer</button>
        <div class="timer-display" id="timer-display">30</div>
      </div>
      <div class="timer-track"><div class="timer-fill" id="timer-fill"></div></div>
    </div>
  </div>
</div>

<!-- FINAL JEOPARDY MODAL -->
<div class="modal-overlay" id="fj-overlay" onclick="handleFJOverlayClick(event)">
  <div class="fj-modal" id="fj-modal">
    <button class="close-modal" onclick="closeFJ()">&times;</button>
    <div class="fj-title">FINAL JEOPARDY!</div>
    <div class="clue-question" id="fj-q"></div>
    <button class="reveal-btn" id="fj-reveal-btn" onclick="revealFJAnswer()">Reveal Answer</button>
    <div class="clue-answer" id="fj-answer">
      <div class="answer-label">Answer</div>
      <div class="answer-text" id="fj-a"></div>
    </div>
  </div>
</div>

<!-- DAILY DOUBLE -->
<div class="daily-double-splash" id="dd-splash" onclick="dismissDD()">
  <div class="dd-particles" id="dd-particles"></div>
  <div class="dd-content">
    <span class="dd-stars">
      <span class="dd-star-item" style="animation-delay:0.1s">&#11088;</span>
      <span class="dd-star-item" style="animation-delay:0.2s">&#10024;</span>
      <span class="dd-star-item" style="animation-delay:0.3s">&#11088;</span>
      <span class="dd-star-item" style="animation-delay:0.4s">&#10024;</span>
      <span class="dd-star-item" style="animation-delay:0.5s">&#11088;</span>
    </span>
    <div class="dd-text">DAILY DOUBLE!</div>
    <div class="dd-subtitle">Click to continue</div>
  </div>
</div>

<!-- VICTORY CELEBRATION -->
<div class="victory-overlay" id="victory-overlay" onclick="dismissVictory()">
  <canvas id="victory-confetti-canvas" style="position:absolute;inset:0;z-index:1;pointer-events:none;"></canvas>
  <div class="victory-content">
    <span class="victory-crown">&#128081;</span>
    <div class="victory-title">GAME COMPLETE!</div>
    <div class="victory-stats">
      <div class="victory-stat">
        <div class="victory-stat-number" id="v-stat-clues">25</div>
        <div class="victory-stat-label">Clues Answered</div>
      </div>
      <div class="victory-stat">
        <div class="victory-stat-number" id="v-stat-time">0:00</div>
        <div class="victory-stat-label">Total Time</div>
      </div>
      <div class="victory-stat">
        <div class="victory-stat-number" id="v-stat-dd">0</div>
        <div class="victory-stat-label">Daily Doubles</div>
      </div>
    </div>
    <div class="victory-subtitle">Click anywhere to close &bull; What a game!</div>
  </div>
</div>

<a class="tswift-btn" href="https://youtu.be/WWY06TxIrh4?si=IIPKcmJF7-wOkPwT" target="_blank" rel="noopener" title="T-Swift Mode">TS</a>
<div style="position:fixed;bottom:12px;right:144px;z-index:500;">
  <button class="lofi-btn" id="lofi-btn" onclick="toggleLofi()" oncontextmenu="event.preventDefault();toggleLofiVol();" title="Lo-Fi Music · Right-click for volume" style="position:static;">&#9835;</button>
  <div class="lofi-vol-wrap" id="lofi-vol-wrap">
    <div class="lofi-vol-pct" id="lofi-vol-pct">35%</div>
    <input type="range" id="lofi-vol-slider" min="0" max="100" value="35" oninput="adjustLofiVolume(this.value)">
  </div>
</div>
<button class="kb-hint-btn" id="kb-hint-btn" onclick="toggleKeyboardHints()" title="Keyboard Shortcuts">&#9000;</button>
<div class="keyboard-hints" id="keyboard-hints">
  <kbd>SPACE</kbd> Reveal Answer / Dismiss<br>
  <kbd>Q</kbd> Close Modal<br>
  <kbd>T</kbd> Start / Pause Timer<br>
  <kbd>F</kbd> Toggle Fullscreen<br>
  <kbd>M</kbd> Toggle Sound
</div>

<button class="fullscreen-btn" id="fullscreen-btn" onclick="toggleFullscreen()" title="Toggle Fullscreen">&#x26F6;</button>
<button class="settings-btn" onclick="toggleSettings()" title="Settings">&#9881;</button>
<div class="settings-panel" id="settings-panel">
  <h3>Settings</h3>
  <div class="setting-row"><label>Timer (sec)</label><input type="number" id="timer-seconds" min="10" max="120" value="20"></div>
  <div class="setting-row"><label>Daily Doubles</label><input type="number" id="dd-count" min="0" max="3" value="1" onchange="resetDailyDoubles()"></div>
  <button class="reset-btn" onclick="resetGame()">Reset Game</button>
</div>

<script>
/* ═══════════════════════════════════════════════════
   DATA
   ═══════════════════════════════════════════════════ */
var CATEGORIES = [
  { name: "Patient Experience & Surveys", clues: [
    { q: "Patients receiving care in these three settings each receive their own version of a CAHPS or Press Ganey patient experience survey.", a: "What are Inpatient, Outpatient Ambulatory Surgery, and Emergency Department?" },
    { q: "On the HCAHPS inpatient survey, this is the response option that counts as a \"top box\" score for questions about nurses and doctors.", a: "What is \"Always\"?" },
    { q: "On the HCAHPS survey, patients answer questions about nurse communication across three areas: courtesy and respect, explaining things clearly, and this.", a: "What is listening carefully?" },
    { q: "This question is our main national benchmark indicator.", a: "What is \"Likelihood to Recommend\"?" },
    { q: "According to the retreat presentation, a satisfied patient tells 3 people about their experience, but a dissatisfied patient tells up to this many.", a: "What is 25?" }
  ]},
  { name: "Running Your Council", clues: [
    { q: "Every CCC must have three designated positions: the Co-Chairs, the Scribe, and this person who keeps the meeting on schedule.", a: "Who is the Timekeeper?" },
    { q: "This person is a member of the council but is NOT the chair \u2014 they bring operational expertise and a global perspective to the CCC.", a: "Who is the Manager?" },
    { q: "CCC meetings should be scheduled at this frequency, on a consistent day and time, ideally for one hour.", a: "What is monthly?" },
    { q: "The recommended CCC agenda starts with a Check-In Question and ends with a review of these, including task, owner, and due date.", a: "What are Action Items?" },
    { q: "On the CCC Traffic Light report, a council earns a GREEN rating when more than this percentage of meetings are held with a consistent interdisciplinary team and implemented PIPs.", a: "What is 80%?" }
  ]},
  { name: "Communication & Empathy", clues: [
    { q: "Northwell Health's Culture of C.A.R.E. stands for Connectedness, Awareness, Respect, and this fourth value.", a: "What is Empathy?" },
    { q: "In the L.A.S.T. service recovery model, the \"S\" stands for \"Solve the problem\" and is paired with this encouraging phrase.", a: "What is \"Find the Yes!\"?" },
    { q: "This seven-letter communication model starts with Contact and ends with Thank, and includes steps for Opening Greeting, Name, Needs, Explanation, and Closing.", a: "What is C.O.N.N.E.C.T.?" },
    { q: "The L.A.S.T. model's \"A\" step instructs staff to do this when a patient has a concern.", a: "What is Apologize?" },
    { q: "According to Northwell, this is the definition of patient experience \u2014 a philosophy at the heart of the Culture of C.A.R.E. that reminds every team member that what they do matters.", a: "What is \"Every Role, Every Person, Every Moment Matters\"?" }
  ]},
  { name: "Magnet", clues: [
    { q: "LIJ recently achieved this milestone in its Magnet journey, making it one of only 9.8% of U.S. hospitals to hold this designation.", a: "What is the 3rd Magnet Redesignation?" },
    { q: "Patient Safety and Clinical Quality Improvement are two areas where council work directly supports Magnet. This third area focuses on making the unit a better place to work.", a: "What is Healthy Work Environment?" },
    { q: "Nhadelle shared three ways councils sustain Magnet culture: Motivate your team, Keep a pulse on performance, and do this with ALL of the work you do.", a: "What is Document (it)?" },
    { q: "LIJ's next Magnet redesignation document, covering 103 standards and over 1,800 pages, is due on this date.", a: "What is October 1, 2028?" },
    { q: "Magnet isn't just about a designation. According to the presentation, it's about consciously creating a culture focused on four areas: Healthy & Safe Work Environments, Professional Development, Excellent Patient Outcomes, and this.", a: "What is Patient & Employee Satisfaction?" }
  ]},
  { name: "Northwell Knowledge", clues: [
    { q: "LIJ Medical Center's mailing address is in this village in Nassau County, just 15 miles east of Manhattan.", a: "What is New Hyde Park?" },
    { q: "Before rebranding on January 1, 2016, Northwell Health was known by this name.", a: "What is the North Shore\u2013Long Island Jewish Health System (North Shore-LIJ)?" },
    { q: "Northwell's current President and CEO started his career as an emergency medicine physician at Glen Cove Hospital over 25 years ago. Name him.", a: "Who is Dr. John D'Angelo?" },
    { q: "In 2025, Northwell completed a major merger with this health system, expanding into Connecticut and the Hudson Valley.", a: "What is Nuvance Health?" },
    { q: "Northwell's mission statement says: \"To improve the health and quality of life for those we serve by providing world-class service and ___ care.\"", a: "What is compassionate?" }
  ]}
];

var FINAL_JEOPARDY = {
  q: "This is the one thing that connects every HCAHPS domain, every CCC initiative, and every star rating \u2014 the single most important element of everything we do.",
  a: "What is the patient experience?"
};

var VALUES = [100, 200, 300, 400, 500];
var usedClues = {};
var dailyDoubles = {};
var timerInterval = null;
var timerRunning = false;
var soundEnabled = true;
var fjUsed = false;
var heartbeatInterval = null;
var audioCtx = null;
var musicNodes = null;
var boardRevealed = false;
var categoryTypewriterDone = false;
var currentProgressDisplay = 0;
var gameStartTime = null;
var dailyDoublesHit = 0;
var thinkMusicNodes = null;
var victoryShown = false;
var lofiPlaying = false;
var lofiIntervals = [];
var lofiOscillators = [];
var lofiMasterGain = null;

/* ═══════════════════════════════════════════════════
   AUDIO ENGINE
   ═══════════════════════════════════════════════════ */
function initAudio() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (audioCtx.state === 'suspended') audioCtx.resume();
}

/* ═══════════════════════════════════════════════════
   🎵 GAME SHOW CLASSIC — BACKGROUND MUSIC ENGINE
   Upbeat pizzicato bass + bright staccato melody +
   light rhythmic pulse. Loops infinitely via bar system.
   ═══════════════════════════════════════════════════ */
function startLofi() {
  initAudio();
  lofiPlaying = true;
  lofiIntervals = [];
  lofiOscillators = [];

  lofiMasterGain = audioCtx.createGain();
  var lofiVol = (window._lofiVolume !== undefined) ? window._lofiVolume : 0.35;
  lofiMasterGain.gain.setValueAtTime(0, audioCtx.currentTime);
  lofiMasterGain.gain.linearRampToValueAtTime(lofiVol, audioCtx.currentTime + 2);
  lofiMasterGain.connect(audioCtx.destination);

  var BPM = 132;
  var beatDur = 60 / BPM;
  var barDur = beatDur * 4;

  var chords = [
    [130.81, 164.81, 196.00],
    [110.00, 130.81, 164.81],
    [87.31, 110.00, 130.81],
    [98.00, 123.47, 146.83],
    [130.81, 164.81, 196.00],
    [110.00, 130.81, 164.81],
    [87.31, 110.00, 130.81],
    [98.00, 130.81, 164.81],
  ];

  var bassLines = [
    [130.81, 0, 130.81, 146.83],
    [110.00, 0, 130.81, 110.00],
    [87.31, 0, 110.00, 87.31],
    [98.00, 0, 110.00, 98.00],
    [130.81, 0, 146.83, 130.81],
    [110.00, 0, 98.00, 110.00],
    [87.31, 0, 87.31, 98.00],
    [98.00, 0, 123.47, 98.00],
  ];

  var melodyBars = [
    [{ beat: 0, note: 523.25, dur: 0.12 }, { beat: 1.5, note: 587.33, dur: 0.08 }, { beat: 2, note: 659.26, dur: 0.15 }],
    [{ beat: 0, note: 523.25, dur: 0.1 }, { beat: 2, note: 440.00, dur: 0.12 }, { beat: 3, note: 493.88, dur: 0.08 }],
    [{ beat: 0.5, note: 440.00, dur: 0.12 }, { beat: 1.5, note: 523.25, dur: 0.1 }, { beat: 3, note: 349.23, dur: 0.15 }],
    [{ beat: 0, note: 392.00, dur: 0.12 }, { beat: 1, note: 493.88, dur: 0.1 }, { beat: 2.5, note: 587.33, dur: 0.12 }, { beat: 3.5, note: 523.25, dur: 0.1 }],
    [{ beat: 0, note: 659.26, dur: 0.15 }, { beat: 1, note: 587.33, dur: 0.08 }, { beat: 2.5, note: 523.25, dur: 0.12 }],
    [{ beat: 0.5, note: 440.00, dur: 0.12 }, { beat: 2, note: 523.25, dur: 0.1 }, { beat: 3, note: 440.00, dur: 0.08 }],
    [{ beat: 0, note: 349.23, dur: 0.12 }, { beat: 1.5, note: 440.00, dur: 0.1 }, { beat: 2.5, note: 523.25, dur: 0.15 }],
    [{ beat: 0, note: 493.88, dur: 0.1 }, { beat: 1, note: 587.33, dur: 0.12 }, { beat: 2, note: 659.26, dur: 0.2 }],
  ];

  function playPizzBass(freq, time, vol) {
    if (!lofiPlaying) return;
    var osc = audioCtx.createOscillator();
    var gain = audioCtx.createGain();
    var filter = audioCtx.createBiquadFilter();
    osc.type = 'triangle';
    osc.frequency.value = freq;
    filter.type = 'lowpass';
    filter.frequency.value = 1200;
    filter.Q.value = 2;
    gain.gain.setValueAtTime(0.001, time);
    gain.gain.linearRampToValueAtTime(vol, time + 0.015);
    gain.gain.exponentialRampToValueAtTime(0.001, time + 0.22);
    osc.connect(filter);
    filter.connect(gain);
    gain.connect(lofiMasterGain);
    osc.start(time);
    osc.stop(time + 0.25);
  }

  function playStaccatoMelody(freq, time, dur, vol) {
    if (!lofiPlaying) return;
    var osc = audioCtx.createOscillator();
    var gain = audioCtx.createGain();
    osc.type = 'sine';
    osc.frequency.value = freq;
    gain.gain.setValueAtTime(0.001, time);
    gain.gain.linearRampToValueAtTime(vol, time + 0.01);
    gain.gain.setValueAtTime(vol, time + dur * 0.6);
    gain.gain.exponentialRampToValueAtTime(0.001, time + dur);
    osc.connect(gain);
    gain.connect(lofiMasterGain);
    osc.start(time);
    osc.stop(time + dur + 0.05);
  }

  function playRhythmTick(time, accent) {
    if (!lofiPlaying) return;
    var bufferSize = audioCtx.sampleRate * 0.04;
    var buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
    var data = buffer.getChannelData(0);
    for (var i = 0; i < bufferSize; i++) { data[i] = (Math.random() * 2 - 1); }
    var source = audioCtx.createBufferSource();
    source.buffer = buffer;
    var filter = audioCtx.createBiquadFilter();
    filter.type = 'highpass';
    filter.frequency.value = accent ? 6000 : 8000;
    var gain = audioCtx.createGain();
    gain.gain.setValueAtTime(accent ? 0.045 : 0.025, time);
    gain.gain.exponentialRampToValueAtTime(0.001, time + 0.05);
    source.connect(filter);
    filter.connect(gain);
    gain.connect(lofiMasterGain);
    source.start(time);
    source.stop(time + 0.06);
  }

  function playChordPad(notes, time) {
    if (!lofiPlaying) return;
    notes.forEach(function(freq) {
      var osc = audioCtx.createOscillator();
      var gain = audioCtx.createGain();
      var filter = audioCtx.createBiquadFilter();
      osc.type = 'sine';
      osc.frequency.value = freq * 2;
      filter.type = 'lowpass';
      filter.frequency.value = 600;
      gain.gain.setValueAtTime(0.001, time);
      gain.gain.linearRampToValueAtTime(0.012, time + 0.3);
      gain.gain.setValueAtTime(0.012, time + barDur * 0.7);
      gain.gain.exponentialRampToValueAtTime(0.001, time + barDur);
      osc.connect(filter);
      filter.connect(gain);
      gain.connect(lofiMasterGain);
      osc.start(time);
      osc.stop(time + barDur + 0.1);
    });
  }

  function scheduleLoop() {
    if (!lofiPlaying) return;
    var startTime = audioCtx.currentTime + 0.1;

    for (var bar = 0; bar < 8; bar++) {
      var barStart = startTime + (bar * barDur);
      var barIdx = bar % 8;

      playChordPad(chords[barIdx], barStart);

      var bass = bassLines[barIdx];
      for (var b = 0; b < 4; b++) {
        if (bass[b] > 0) {
          playPizzBass(bass[b], barStart + (b * beatDur), 0.07);
        }
      }

      var melNotes = melodyBars[barIdx];
      melNotes.forEach(function(m) {
        playStaccatoMelody(m.note, barStart + (m.beat * beatDur), m.dur, 0.06);
      });

      for (var eighth = 0; eighth < 8; eighth++) {
        var tickTime = barStart + (eighth * beatDur * 0.5);
        var accent = (eighth === 0 || eighth === 4);
        playRhythmTick(tickTime, accent);
      }
    }

    var totalLoopDur = 8 * barDur;
    var tid = setTimeout(function() {
      scheduleLoop();
    }, (totalLoopDur - 0.5) * 1000);
    lofiIntervals.push(tid);
  }

  scheduleLoop();
}

function stopLofi() {
  lofiPlaying = false;
  lofiIntervals.forEach(function(t) { clearTimeout(t); });
  lofiIntervals = [];
  if (lofiMasterGain) {
    try {
      lofiMasterGain.gain.linearRampToValueAtTime(0.001, audioCtx.currentTime + 1.0);
    } catch(e) {}
  }
  setTimeout(function() { lofiMasterGain = null; }, 1200);
}

function toggleLofi() {
  var btn = document.getElementById('lofi-btn');
  if (lofiPlaying) {
    stopLofi();
    btn.classList.remove('playing');
    btn.title = 'Lo-Fi Music · Right-click for volume';
  } else {
    startLofi();
    btn.classList.add('playing');
    btn.title = 'Stop Lo-Fi · Right-click for volume';
  }
}

function toggleLofiVol() {
  document.getElementById('lofi-vol-wrap').classList.toggle('active');
}

function adjustLofiVolume(val) {
  var lofiVol = val / 100;
  document.getElementById('lofi-vol-pct').textContent = val + '%';
  if (lofiPlaying && lofiMasterGain) {
    try { lofiMasterGain.gain.setValueAtTime(lofiVol * 0.5, audioCtx.currentTime); } catch(e) {}
  }
  // Store for next startLofi call
  window._lofiVolume = lofiVol;
}

function playTone(freq, duration, type, vol) {
  if (!soundEnabled) return;
  initAudio();
  type = type || 'sine';
  vol = (vol || 0.15) * masterVolume;
  var osc = audioCtx.createOscillator();
  var gain = audioCtx.createGain();
  osc.type = type;
  osc.frequency.value = freq;
  gain.gain.setValueAtTime(vol, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime + duration);
  // Clean up nodes after playback to prevent memory accumulation
  osc.onended = function() { try { osc.disconnect(); gain.disconnect(); } catch(e) {} };
}

function playClickSound() { playTone(800, 0.1, 'sine', 0.08); }

function playRevealSound() {
  playTone(523, 0.15, 'sine', 0.1);
  setTimeout(function() { playTone(659, 0.15, 'sine', 0.1); }, 100);
  setTimeout(function() { playTone(784, 0.2, 'sine', 0.1); }, 200);
}

function playConfettiSound() {
  playTone(523, 0.1, 'sine', 0.1);
  setTimeout(function() { playTone(659, 0.1, 'sine', 0.1); }, 60);
  setTimeout(function() { playTone(784, 0.1, 'sine', 0.1); }, 120);
  setTimeout(function() { playTone(1047, 0.25, 'sine', 0.12); }, 180);
}

function playHeartbeat() {
  if (!soundEnabled) return;
  initAudio();
  playTone(60, 0.15, 'sine', 0.35);
  setTimeout(function() {
    if (!soundEnabled) return;
    playTone(55, 0.12, 'sine', 0.25);
  }, 120);
}

function playTimesUpBuzzer() {
  if (!soundEnabled) return;
  initAudio();
  for (var i = 0; i < 3; i++) {
    (function(idx) {
      setTimeout(function() { playTone(180, 0.25, 'sawtooth', 0.18); }, idx * 180);
    })(i);
  }
}

function playDDSound() {
  if (!soundEnabled) return;
  initAudio();
  var notes = [392, 494, 587, 659, 784, 988, 784, 988, 1175];
  for (var i = 0; i < notes.length; i++) {
    (function(idx) {
      setTimeout(function() { playTone(notes[idx], 0.18, 'sine', 0.12); }, idx * 80);
    })(i);
  }
  setTimeout(function() {
    for (var j = 0; j < 5; j++) {
      (function(jj) {
        setTimeout(function() { playTone(2000 + Math.random() * 2000, 0.1, 'sine', 0.04); }, jj * 50);
      })(j);
    }
  }, 600);
}

/* ═══════════════════════════════════════════
   BOARD REVEAL — ORCHESTRAL SWELL
   ═══════════════════════════════════════════ */
function playBoardRevealSwell() {
  if (!soundEnabled) return;
  initAudio();
  var t = audioCtx.currentTime;
  var chordNotes = [130.81, 164.81, 196.00];
  chordNotes.forEach(function(freq, i) {
    var osc = audioCtx.createOscillator();
    var gain = audioCtx.createGain();
    osc.type = 'sawtooth';
    osc.frequency.value = freq;
    gain.gain.setValueAtTime(0.001, t);
    gain.gain.linearRampToValueAtTime(0.06, t + 0.8);
    gain.gain.exponentialRampToValueAtTime(0.001, t + 2.5);
    var filter = audioCtx.createBiquadFilter();
    filter.type = 'lowpass';
    filter.frequency.value = 800;
    osc.connect(filter);
    filter.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start(t + i * 0.05);
    osc.stop(t + 2.5);
    osc.onended = function() { try { osc.disconnect(); filter.disconnect(); gain.disconnect(); } catch(e) {} };
  });
  var midNotes = [261.63, 329.63, 392.00, 523.25];
  midNotes.forEach(function(freq, i) {
    var osc = audioCtx.createOscillator();
    var gain = audioCtx.createGain();
    osc.type = 'sine';
    osc.frequency.value = freq;
    gain.gain.setValueAtTime(0.001, t + 0.3);
    gain.gain.linearRampToValueAtTime(0.08, t + 1.2);
    gain.gain.exponentialRampToValueAtTime(0.001, t + 3);
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start(t + 0.3 + i * 0.08);
    osc.stop(t + 3);
    osc.onended = function() { try { osc.disconnect(); gain.disconnect(); } catch(e) {} };
  });
  var highNotes = [1046.50, 1318.51, 1567.98];
  highNotes.forEach(function(freq, i) {
    var osc = audioCtx.createOscillator();
    var gain = audioCtx.createGain();
    osc.type = 'sine';
    osc.frequency.value = freq;
    gain.gain.setValueAtTime(0.001, t + 0.8);
    gain.gain.linearRampToValueAtTime(0.03, t + 1.5);
    gain.gain.exponentialRampToValueAtTime(0.001, t + 3.5);
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start(t + 0.8 + i * 0.12);
    osc.stop(t + 3.5);
    osc.onended = function() { try { osc.disconnect(); gain.disconnect(); } catch(e) {} };
  });
}

/* ═══════════════════════════════════════════════════
   🎵 DREAMY SYNTH-POP INSTRUMENTAL
   Original composition: bright arpeggios, warm pads,
   soft bass, shimmering leads. Upbeat & modern feel.
   Loops seamlessly every ~32 seconds.
   ═══════════════════════════════════════════════════ */
function startGameShowMusic() {
  if (!soundEnabled || musicNodes || musicFading) return;
  initAudio();
  musicNodes = { active: true, timeouts: [] };

  var mg = audioCtx.createGain();
  mg.gain.setValueAtTime(0, audioCtx.currentTime);
  mg.gain.linearRampToValueAtTime(masterVolume * 0.7, audioCtx.currentTime + 3);
  mg.connect(audioCtx.destination);
  musicNodes.masterGain = mg;

  var BPM = 120;
  var beat = 60 / BPM;
  var eighth = beat / 2;
  var bar = beat * 4;

  // ── Reverb impulse (simple synthetic) ──
  var reverbLen = audioCtx.sampleRate * 1.8;
  var reverbBuf = audioCtx.createBuffer(2, reverbLen, audioCtx.sampleRate);
  for (var ch = 0; ch < 2; ch++) {
    var rd = reverbBuf.getChannelData(ch);
    for (var i = 0; i < reverbLen; i++) {
      rd[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / reverbLen, 2.5);
    }
  }
  var reverb = audioCtx.createConvolver();
  reverb.buffer = reverbBuf;
  var reverbGain = audioCtx.createGain();
  reverbGain.gain.value = 0.25;
  reverb.connect(reverbGain);
  reverbGain.connect(mg);

  var dryGain = audioCtx.createGain();
  dryGain.gain.value = 0.75;
  dryGain.connect(mg);

  // Mix bus: everything goes through dry + reverb
  var mixBus = audioCtx.createGain();
  mixBus.gain.value = 1;
  mixBus.connect(dryGain);
  mixBus.connect(reverb);

  // ── Synth pad (warm, lush) ──
  function synthPad(freqs, time, dur, vol) {
    if (!musicNodes || !musicNodes.active) return;
    freqs.forEach(function(freq) {
      ['sine', 'triangle'].forEach(function(type, ti) {
        var o = audioCtx.createOscillator();
        var g = audioCtx.createGain();
        var f = audioCtx.createBiquadFilter();
        o.type = type;
        o.frequency.value = freq * (1 + ti * 0.002); // slight detune
        f.type = 'lowpass'; f.frequency.value = 800 + ti * 200;
        var v = vol * (ti === 0 ? 0.7 : 0.3);
        g.gain.setValueAtTime(0.001, time);
        g.gain.linearRampToValueAtTime(v, time + 0.4);
        g.gain.setValueAtTime(v * 0.9, time + dur * 0.6);
        g.gain.linearRampToValueAtTime(v * 0.8, time + dur * 0.85);
        g.gain.exponentialRampToValueAtTime(0.001, time + dur);
        o.connect(f); f.connect(g); g.connect(mixBus);
        o.start(time); o.stop(time + dur + 0.1);
        o.onended = function() { try { o.disconnect(); f.disconnect(); g.disconnect(); } catch(e) {} };
      });
    });
  }

  // ── Arpeggio (bright, sparkly) ──
  function arp(freq, time, dur, vol) {
    if (!musicNodes || !musicNodes.active) return;
    var o = audioCtx.createOscillator();
    var g = audioCtx.createGain();
    var f = audioCtx.createBiquadFilter();
    o.type = 'sine';
    o.frequency.value = freq;
    f.type = 'lowpass'; f.frequency.value = 3000;
    g.gain.setValueAtTime(0.001, time);
    g.gain.linearRampToValueAtTime(vol, time + 0.01);
    g.gain.setValueAtTime(vol * 0.6, time + dur * 0.3);
    g.gain.exponentialRampToValueAtTime(0.001, time + dur);
    o.connect(f); f.connect(g); g.connect(mixBus);
    o.start(time); o.stop(time + dur + 0.05);
    o.onended = function() { try { o.disconnect(); f.disconnect(); g.disconnect(); } catch(e) {} };
    // shimmer octave
    var o2 = audioCtx.createOscillator();
    var g2 = audioCtx.createGain();
    o2.type = 'sine'; o2.frequency.value = freq * 2;
    g2.gain.setValueAtTime(0.001, time);
    g2.gain.linearRampToValueAtTime(vol * 0.15, time + 0.01);
    g2.gain.exponentialRampToValueAtTime(0.001, time + dur * 0.7);
    o2.connect(g2); g2.connect(mixBus);
    o2.start(time); o2.stop(time + dur + 0.05);
    o2.onended = function() { try { o2.disconnect(); g2.disconnect(); } catch(e) {} };
  }

  // ── Sub bass (warm, round) ──
  function subBass(freq, time, dur, vol) {
    if (!musicNodes || !musicNodes.active) return;
    var o = audioCtx.createOscillator();
    var g = audioCtx.createGain();
    var f = audioCtx.createBiquadFilter();
    o.type = 'sine'; o.frequency.value = freq;
    f.type = 'lowpass'; f.frequency.value = 300;
    g.gain.setValueAtTime(0.001, time);
    g.gain.linearRampToValueAtTime(vol, time + 0.03);
    g.gain.setValueAtTime(vol * 0.8, time + dur * 0.7);
    g.gain.exponentialRampToValueAtTime(0.001, time + dur);
    o.connect(f); f.connect(g); g.connect(dryGain); // bass stays dry
    o.start(time); o.stop(time + dur + 0.05);
    o.onended = function() { try { o.disconnect(); f.disconnect(); g.disconnect(); } catch(e) {} };
  }

  // ── Soft kick ──
  function kick(time, vol) {
    if (!musicNodes || !musicNodes.active) return;
    var o = audioCtx.createOscillator();
    var g = audioCtx.createGain();
    o.type = 'sine'; o.frequency.setValueAtTime(150, time);
    o.frequency.exponentialRampToValueAtTime(40, time + 0.12);
    g.gain.setValueAtTime(vol, time);
    g.gain.exponentialRampToValueAtTime(0.001, time + 0.25);
    o.connect(g); g.connect(dryGain);
    o.start(time); o.stop(time + 0.3);
    o.onended = function() { try { o.disconnect(); g.disconnect(); } catch(e) {} };
  }

  // ── Hi-hat (soft) ──
  function hat(time, vol, open) {
    if (!musicNodes || !musicNodes.active) return;
    var len = audioCtx.sampleRate * (open ? 0.08 : 0.03);
    var buf = audioCtx.createBuffer(1, len, audioCtx.sampleRate);
    var d = buf.getChannelData(0);
    for (var i = 0; i < len; i++) d[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / len, open ? 1.5 : 3);
    var s = audioCtx.createBufferSource(); s.buffer = buf;
    var f = audioCtx.createBiquadFilter();
    f.type = 'highpass'; f.frequency.value = 8000;
    var g = audioCtx.createGain();
    g.gain.setValueAtTime(vol, time);
    g.gain.exponentialRampToValueAtTime(0.001, time + (open ? 0.12 : 0.04));
    s.connect(f); f.connect(g); g.connect(mixBus);
    s.start(time); s.stop(time + 0.15);
    s.onended = function() { try { s.disconnect(); f.disconnect(); g.disconnect(); } catch(e) {} };
  }

  // ── Lead melody (dreamy, high register) ──
  function lead(freq, time, dur, vol) {
    if (!musicNodes || !musicNodes.active) return;
    var o = audioCtx.createOscillator();
    var o2 = audioCtx.createOscillator();
    var g = audioCtx.createGain();
    var f = audioCtx.createBiquadFilter();
    o.type = 'sine'; o.frequency.value = freq;
    o2.type = 'triangle'; o2.frequency.value = freq * 1.003; // slight detune for width
    f.type = 'lowpass'; f.frequency.value = 2500;
    g.gain.setValueAtTime(0.001, time);
    g.gain.linearRampToValueAtTime(vol, time + 0.05);
    g.gain.setValueAtTime(vol * 0.7, time + dur * 0.5);
    g.gain.exponentialRampToValueAtTime(0.001, time + dur);
    o.connect(f); o2.connect(f); f.connect(g); g.connect(mixBus);
    o.start(time); o.stop(time + dur + 0.05);
    o2.start(time); o2.stop(time + dur + 0.05);
    o.onended = function() { try { o.disconnect(); } catch(e) {} };
    o2.onended = function() { try { o2.disconnect(); f.disconnect(); g.disconnect(); } catch(e) {} };
  }

  /* ── CHORD PROGRESSION (8 bars, key of D major / Bm) ──
     Original progression: D - A - Bm - G  |  D - A - G - A
     Bright, uplifting, modern pop feel */

  var chords = [
    // Section A (4 bars)
    { root: 73.42, pad: [293.66, 369.99, 440.00], arpNotes: [293.66, 369.99, 440.00, 587.33] },  // D
    { root: 55.00, pad: [277.18, 329.63, 440.00], arpNotes: [277.18, 329.63, 440.00, 554.37] },  // A
    { root: 61.74, pad: [246.94, 293.66, 369.99], arpNotes: [246.94, 293.66, 369.99, 493.88] },  // Bm
    { root: 49.00, pad: [196.00, 246.94, 293.66], arpNotes: [196.00, 246.94, 293.66, 392.00] },  // G
    // Section B (4 bars)
    { root: 73.42, pad: [293.66, 369.99, 440.00], arpNotes: [293.66, 369.99, 440.00, 587.33] },  // D
    { root: 55.00, pad: [277.18, 329.63, 440.00], arpNotes: [277.18, 329.63, 440.00, 554.37] },  // A
    { root: 49.00, pad: [196.00, 246.94, 293.66], arpNotes: [196.00, 246.94, 293.66, 392.00] },  // G
    { root: 55.00, pad: [277.18, 329.63, 440.00], arpNotes: [277.18, 329.63, 440.00, 554.37] },  // A
  ];

  /* ── ORIGINAL MELODY (two 4-bar phrases) ──
     Dreamy, singable, major-key. [freq, startBeat (within 4-bar section), duration in beats] */
  var melodyA = [
    [587.33, 0, 1],      // D5
    [659.26, 1, 0.5],    // E5
    [739.99, 1.5, 1.5],  // F#5
    [659.26, 3, 1],       // E5
    [587.33, 4, 2],       // D5
    [554.37, 6, 0.5],    // C#5
    [493.88, 6.5, 1.5],  // B4
    [440.00, 8, 1],       // A4
    [493.88, 9, 0.5],    // B4
    [554.37, 9.5, 0.5],  // C#5
    [587.33, 10, 2],      // D5
    [493.88, 12, 1.5],   // B4
    [440.00, 13.5, 0.5], // A4
    [392.00, 14, 1],      // G4
    [440.00, 15, 1],      // A4
  ];

  var melodyB = [
    [587.33, 0, 1],       // D5
    [659.26, 1, 0.5],    // E5
    [739.99, 1.5, 1],    // F#5
    [880.00, 2.5, 1.5],  // A5
    [739.99, 4, 1],       // F#5
    [659.26, 5, 1],       // E5
    [587.33, 6, 2],       // D5
    [554.37, 8, 1],       // C#5
    [493.88, 9, 1],       // B4
    [440.00, 10, 1],      // A4
    [493.88, 11, 1],      // B4
    [587.33, 12, 3],      // D5 (held)
    [554.37, 15, 0.5],   // C#5 pickup
    [493.88, 15.5, 0.5], // B4 pickup
  ];

  function scheduleSection(startTime) {
    if (!musicNodes || !musicNodes.active) return;
    var t = startTime;

    for (var i = 0; i < 8; i++) {
      if (!musicNodes || !musicNodes.active) return;
      var chord = chords[i];
      var barStart = t + i * bar;

      // Warm pad (whole bar)
      synthPad(chord.pad, barStart, bar * 0.95, 0.025);

      // Sub bass (half notes)
      subBass(chord.root, barStart, beat * 1.8, 0.06);
      subBass(chord.root, barStart + beat * 2, beat * 1.8, 0.05);

      // Arpeggios (eighth notes cycling through chord tones)
      for (var a = 0; a < 8; a++) {
        var aNote = chord.arpNotes[a % chord.arpNotes.length];
        // Go up then back for a pleasing pattern
        if (a >= 4) aNote = chord.arpNotes[(7 - a) % chord.arpNotes.length];
        arp(aNote, barStart + a * eighth, eighth * 0.85, 0.035);
      }

      // Soft kick on 1 and 3
      kick(barStart, 0.04);
      kick(barStart + beat * 2, 0.03);

      // Hi-hats (eighth notes, accent on offbeats)
      for (var h = 0; h < 8; h++) {
        hat(barStart + h * eighth, h % 2 === 1 ? 0.02 : 0.012, h % 4 === 2);
      }
    }

    // Lead melody over the 8 bars
    melodyA.forEach(function(n) {
      lead(n[0], t + n[1] * beat, n[2] * beat * 0.9, 0.04);
    });
    melodyB.forEach(function(n) {
      lead(n[0], t + 4 * bar + n[1] * beat, n[2] * beat * 0.9, 0.04);
    });
  }

  var sectionDur = 8 * bar; // ~16 seconds at 120bpm, full loop ~16s

  function scheduleLoop() {
    if (!musicNodes || !musicNodes.active) return;
    var t = audioCtx.currentTime + 0.1;

    // Schedule two sections ahead for seamless looping
    scheduleSection(t);
    scheduleSection(t + sectionDur);

    var tid = setTimeout(function() {
      scheduleLoop();
    }, sectionDur * 2 * 1000 - 500); // re-schedule slightly before end
    if (musicNodes) musicNodes.timeouts.push(tid);
  }

  scheduleLoop();
}

var musicFading = false;
function stopGameShowMusic() {
  if (!musicNodes) return;
  musicNodes.active = false;
  if (musicNodes.timeouts) {
    musicNodes.timeouts.forEach(function(t) { clearTimeout(t); });
  }
  var fadingGain = musicNodes.masterGain;
  musicNodes = null;
  if (fadingGain) {
    musicFading = true;
    try {
      fadingGain.gain.cancelScheduledValues(audioCtx.currentTime);
      fadingGain.gain.setValueAtTime(fadingGain.gain.value, audioCtx.currentTime);
      fadingGain.gain.linearRampToValueAtTime(0.001, audioCtx.currentTime + 1.0);
    } catch(e) {}
    setTimeout(function() {
      try { fadingGain.disconnect(); } catch(e) {}
      musicFading = false;
    }, 1100);
  }
}

/* ═══════════════════════════════════════════
   PARTICLE BACKGROUND
   ═══════════════════════════════════════════ */
var particles = [];
var particleCanvas, particleCtx;

function initParticles() {
  particleCanvas = document.getElementById('particle-canvas');
  particleCtx = particleCanvas.getContext('2d');
  resizeParticleCanvas();
  
  for (var i = 0; i < 80; i++) {
    particles.push({
      x: Math.random() * particleCanvas.width,
      y: Math.random() * particleCanvas.height,
      size: 0.5 + Math.random() * 2,
      speedX: (Math.random() - 0.5) * 0.3,
      speedY: (Math.random() - 0.5) * 0.3,
      opacity: 0.1 + Math.random() * 0.3,
      pulse: Math.random() * Math.PI * 2,
      pulseSpeed: 0.005 + Math.random() * 0.015,
      color: Math.random() > 0.7 ? 'rgba(242,169,0,' : (Math.random() > 0.5 ? 'rgba(0,178,169,' : 'rgba(78,168,222,')
    });
  }
  animateParticles();
}

function resizeParticleCanvas() {
  if (particleCanvas) {
    particleCanvas.width = window.innerWidth;
    particleCanvas.height = window.innerHeight;
  }
}

function animateParticles() {
  particleCtx.clearRect(0, 0, particleCanvas.width, particleCanvas.height);
  
  for (var i = 0; i < particles.length; i++) {
    var p = particles[i];
    p.x += p.speedX;
    p.y += p.speedY;
    p.pulse += p.pulseSpeed;
    
    var pulsedOpacity = p.opacity * (0.5 + 0.5 * Math.sin(p.pulse));
    
    if (p.x < -10) p.x = particleCanvas.width + 10;
    if (p.x > particleCanvas.width + 10) p.x = -10;
    if (p.y < -10) p.y = particleCanvas.height + 10;
    if (p.y > particleCanvas.height + 10) p.y = -10;
    
    particleCtx.beginPath();
    particleCtx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
    particleCtx.fillStyle = p.color + pulsedOpacity + ')';
    particleCtx.fill();
    
    if (p.size > 1.2) {
      particleCtx.beginPath();
      particleCtx.arc(p.x, p.y, p.size * 3, 0, Math.PI * 2);
      particleCtx.fillStyle = p.color + (pulsedOpacity * 0.15) + ')';
      particleCtx.fill();
    }
  }
  
  for (var i = 0; i < particles.length; i++) {
    for (var j = i + 1; j < particles.length; j++) {
      var dx = particles[i].x - particles[j].x;
      var dy = particles[i].y - particles[j].y;
      var dist = Math.sqrt(dx * dx + dy * dy);
      if (dist < 120) {
        particleCtx.beginPath();
        particleCtx.moveTo(particles[i].x, particles[i].y);
        particleCtx.lineTo(particles[j].x, particles[j].y);
        particleCtx.strokeStyle = 'rgba(78,168,222,' + (0.03 * (1 - dist / 120)) + ')';
        particleCtx.lineWidth = 0.5;
        particleCtx.stroke();
      }
    }
  }
  
  requestAnimationFrame(animateParticles);
}

/* ═══════════════════════════════════════════
   CINEMATIC SPLASH
   ═══════════════════════════════════════════ */
function initSplash() {
  var title = "JEOPARDY!";
  var container = document.getElementById('splash-title');
  for (var i = 0; i < title.length; i++) {
    var span = document.createElement('span');
    span.className = 'splash-letter';
    span.textContent = title[i];
    span.style.animationDelay = (0.15 + i * 0.1) + 's';
    container.appendChild(span);
  }
  
  var pContainer = document.getElementById('splash-particles');
  for (var i = 0; i < 30; i++) {
    var p = document.createElement('div');
    p.className = 'splash-particle';
    p.style.left = Math.random() * 100 + '%';
    p.style.top = 30 + Math.random() * 60 + '%';
    p.style.animationDelay = Math.random() * 6 + 's';
    p.style.animationDuration = (4 + Math.random() * 4) + 's';
    var size = 2 + Math.random() * 3;
    p.style.width = size + 'px';
    p.style.height = size + 'px';
    if (Math.random() > 0.6) p.style.background = 'var(--northwell-accent)';
    if (Math.random() > 0.8) p.style.background = 'var(--northwell-light)';
    pContainer.appendChild(p);
  }
}

/* ═══════════════════════════════════════════
   CATEGORY TYPEWRITER REVEAL
   ═══════════════════════════════════════════ */
function typewriterCategories() {
  if (categoryTypewriterDone) return;
  categoryTypewriterDone = true;
  var headers = document.querySelectorAll('.category-header');
  headers.forEach(function(header, idx) {
    var h2 = header.querySelector('h2');
    var fullText = header.getAttribute('data-category') || '';
    h2.textContent = '';
    var cursor = document.createElement('span');
    cursor.className = 'typewriter-cursor';
    h2.appendChild(cursor);
    
    var charIdx = 0;
    var baseDelay = idx * 400 + 600; // Stagger by category
    
    setTimeout(function() {
      var interval = setInterval(function() {
        if (charIdx < fullText.length) {
          h2.insertBefore(document.createTextNode(fullText[charIdx]), cursor);
          charIdx++;
          // Click sound for each character
          if (soundEnabled && charIdx % 2 === 0) {
            playTone(1200 + Math.random() * 800, 0.03, 'sine', 0.02);
          }
        } else {
          clearInterval(interval);
          // Remove cursor after a brief pause
          setTimeout(function() { 
            if (cursor.parentNode) cursor.parentNode.removeChild(cursor);
          }, 800);
        }
      }, 45); // Speed per character
    }, baseDelay);
  });
}

/* ═══════════════════════════════════════════
   PROGRESS INDICATOR (animated counter)
   ═══════════════════════════════════════════ */
function updateProgress() {
  var total = 25;
  var answered = Object.keys(usedClues).length;
  var pct = (answered / total) * 100;
  document.getElementById('progress-fill').style.width = pct + '%';
  
  // Animated count-up
  if (answered !== currentProgressDisplay) {
    animateCounter(currentProgressDisplay, answered, total);
    currentProgressDisplay = answered;
  }
  
  if (answered > 0) {
    document.getElementById('progress-label').style.color = 'rgba(255,255,255,0.4)';
  }
}

function animateCounter(from, to, total) {
  var label = document.getElementById('progress-label');
  var steps = Math.abs(to - from);
  var duration = 400; // ms total
  var stepTime = duration / Math.max(steps, 1);
  var current = from;
  
  var counterInterval = setInterval(function() {
    current += (to > from) ? 1 : -1;
    label.textContent = current + ' / ' + total;
    
    // Brief scale pop
    label.style.transform = 'scale(1.3)';
    setTimeout(function() { label.style.transform = 'scale(1)'; }, 100);
    
    if (current === to) {
      clearInterval(counterInterval);
    }
  }, stepTime);
}

/* ═══════════════════════════════════════════
   CELL MOUSE SPOTLIGHT TRACKING
   ═══════════════════════════════════════════ */
function initCellSpotlights() {
  document.addEventListener('mousemove', function(e) {
    var cells = document.querySelectorAll('.cell:not(.used)');
    cells.forEach(function(cell) {
      var rect = cell.getBoundingClientRect();
      var x = ((e.clientX - rect.left) / rect.width) * 100;
      var y = ((e.clientY - rect.top) / rect.height) * 100;
      cell.style.setProperty('--mouse-x', x + '%');
      cell.style.setProperty('--mouse-y', y + '%');
    });
  });
}

/* ═══════════════════════════════════════════
   GAME LOGIC
   ═══════════════════════════════════════════ */
function resetDailyDoubles() {
  dailyDoubles = {};
  var count = parseInt(document.getElementById('dd-count').value) || 1;
  var cells = [];
  for (var c = 0; c < 5; c++) {
    for (var r = 2; r < 5; r++) { cells.push(c + '-' + r); }
  }
  for (var i = cells.length - 1; i > 0; i--) {
    var j = Math.floor(Math.random() * (i + 1));
    var tmp = cells[i]; cells[i] = cells[j]; cells[j] = tmp;
  }
  for (var k = 0; k < Math.min(count, cells.length); k++) {
    dailyDoubles[cells[k]] = true;
  }
}

function buildBoard() {
  var board = document.getElementById('board');
  board.innerHTML = '';
  var idx = 0;
  
  for (var ci = 0; ci < CATEGORIES.length; ci++) {
    var h = document.createElement('div');
    h.className = 'category-header';
    h.setAttribute('data-category', CATEGORIES[ci].name);
    h.innerHTML = '<h2></h2>';
    h.style.animationDelay = (idx * 0.03) + 's';
    board.appendChild(h);
    idx++;
  }
  for (var row = 0; row < 5; row++) {
    for (var col = 0; col < 5; col++) {
      var cell = document.createElement('div');
      var key = col + '-' + row;
      cell.className = 'cell' + (usedClues[key] ? ' used' : '');
      cell.setAttribute('data-key', key);
      cell.style.animationDelay = (idx * 0.03) + 's';
      
      if (usedClues[key]) {
        cell.innerHTML = '<span class="dollar">$' + VALUES[row] + '</span><svg class="checkmark" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="rgba(0,178,169,0.35)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';
      } else {
        cell.innerHTML = '<div class="cell-spotlight"></div><span class="dollar">$' + VALUES[row] + '</span>';
        (function(c, r) { cell.onclick = function() { openClue(c, r, this); }; })(col, row);
      }
      board.appendChild(cell);
      idx++;
    }
  }
  var fj = document.createElement('div');
  fj.className = 'final-jeopardy-btn' + (fjUsed ? ' used' : '');
  fj.innerHTML = '<span>\u2605 \u00a0Final Jeopardy! \u00a0\u2605</span>';
  fj.style.animationDelay = (idx * 0.03) + 's';
  if (!fjUsed) fj.onclick = openFinalJeopardy;
  board.appendChild(fj);
  
  if (boardRevealed) {
    board.classList.add('revealed');
  }
  
  updateProgress();
}

function revealBoard() {
  boardRevealed = true;
  var board = document.getElementById('board');
  board.classList.add('revealed');
  document.getElementById('light-rays').classList.add('active');
  document.getElementById('northwell-watermark').classList.add('active');
  
  // Trigger typewriter after cascade settles
  setTimeout(typewriterCategories, 1200);
}

function openClue(col, row, cellElement) {
  var key = col + '-' + row;
  if (usedClues[key]) return;
  playClickSound();
  
  if (dailyDoubles[key]) { 
    if (cellElement) cellElement.classList.add('flipping');
    setTimeout(function() { showDailyDouble(col, row); }, 400);
    return; 
  }
  
  if (cellElement) {
    cellElement.classList.add('flipping');
  }
  
  setTimeout(function() {
    showClueModal(col, row);
  }, 400);
}

function showDailyDouble(col, row) {
  playDDSound();
  setTimeout(playCrowdMurmur, 300);
  dailyDoublesHit++;
  document.body.classList.add('screen-shake');
  setTimeout(function() { document.body.classList.remove('screen-shake'); }, 600);
  var splash = document.getElementById('dd-splash');
  splash.classList.add('active');
  splash.setAttribute('data-col', col);
  splash.setAttribute('data-row', row);
  spawnDDParticles();
  for (var i = 0; i < 3; i++) {
    (function(idx) {
      setTimeout(function() {
        var ring = document.createElement('div');
        ring.className = 'dd-burst';
        splash.appendChild(ring);
        setTimeout(function() { ring.remove(); }, 1000);
      }, idx * 200);
    })(i);
  }
}

function spawnDDParticles() {
  var container = document.getElementById('dd-particles');
  container.innerHTML = '';
  var colors = ['#F2A900', '#FFD700', '#FFF8DC', '#FF6B00', '#FFFFFF'];
  for (var i = 0; i < 60; i++) {
    var p = document.createElement('div');
    p.className = 'dd-particle';
    var size = 3 + Math.random() * 8;
    p.style.width = size + 'px';
    p.style.height = size + 'px';
    p.style.left = '50%';
    p.style.top = '50%';
    var color = colors[Math.floor(Math.random() * colors.length)];
    p.style.background = color;
    p.style.boxShadow = '0 0 ' + (size * 2) + 'px ' + color;
    var angle = (Math.PI * 2 * i) / 60;
    var dist = 100 + Math.random() * 400;
    var tx = Math.cos(angle) * dist;
    var ty = Math.sin(angle) * dist;
    var dur = 0.8 + Math.random() * 0.6;
    p.style.transition = 'all ' + dur + 's cubic-bezier(0.25,0.46,0.45,0.94)';
    container.appendChild(p);
    (function(el, ttx, tty) {
      requestAnimationFrame(function() {
        requestAnimationFrame(function() {
          el.style.left = 'calc(50% + ' + ttx + 'px)';
          el.style.top = 'calc(50% + ' + tty + 'px)';
          el.style.opacity = '0';
          el.style.transform = 'scale(0.3) rotate(' + (Math.random() * 360) + 'deg)';
        });
      });
    })(p, tx, ty);
  }
}

function dismissDD() {
  var splash = document.getElementById('dd-splash');
  splash.classList.remove('active');
  document.getElementById('dd-particles').innerHTML = '';
  var col = parseInt(splash.getAttribute('data-col'));
  var row = parseInt(splash.getAttribute('data-row'));
  showClueModal(col, row);
}

function showClueModal(col, row) {
  var key = col + '-' + row;
  usedClues[key] = true;
  if (!gameStartTime) gameStartTime = Date.now();
  buildBoard();
  var cat = CATEGORIES[col];
  var clue = cat.clues[row];
  document.getElementById('clue-cat').textContent = cat.name;
  document.getElementById('clue-val').textContent = '$' + VALUES[row];
  document.getElementById('clue-q').textContent = clue.q;
  document.getElementById('clue-a').textContent = clue.a;
  document.getElementById('reveal-btn').style.display = 'block';
  document.getElementById('clue-answer').style.display = 'none';
  resetTimer();
  document.getElementById('timer-bar-container').classList.add('active');
  document.getElementById('clue-overlay').classList.add('active');
}

function revealAnswer() {
  playRevealSound();
  document.getElementById('reveal-btn').style.display = 'none';
  document.getElementById('clue-answer').style.display = 'block';
  stopTimer();
  document.getElementById('timer-bar-container').classList.remove('active');
  document.getElementById('screen-urgency').classList.remove('active');
  document.getElementById('screen-urgency').classList.remove('critical-pulse');
}

function closeClue() {
  stopTimer();
  document.getElementById('screen-urgency').classList.remove('active');
  document.getElementById('screen-urgency').classList.remove('critical-pulse');
  var overlay = document.getElementById('clue-overlay');
  overlay.classList.add('fade-out');
  setTimeout(function() {
    overlay.classList.remove('active');
    overlay.classList.remove('fade-out');
    checkVictory();
  }, 400);
}

function handleOverlayClick(e) {
  if (e.target === document.getElementById('clue-overlay')) closeClue();
}

function openFinalJeopardy() {
  playClickSound();
  fjUsed = true;
  buildBoard();
  document.getElementById('fj-q').textContent = FINAL_JEOPARDY.q;
  document.getElementById('fj-a').textContent = FINAL_JEOPARDY.a;
  document.getElementById('fj-reveal-btn').style.display = 'block';
  document.getElementById('fj-answer').style.display = 'none';
  document.getElementById('fj-overlay').classList.add('active');
}

function revealFJAnswer() {
  playRevealSound();
  document.getElementById('fj-reveal-btn').style.display = 'none';
  document.getElementById('fj-answer').style.display = 'block';
  setTimeout(function() { playConfettiSound(); launchConfetti(); playCrowdApplause(); }, 200);
}

function closeFJ() {
  var overlay = document.getElementById('fj-overlay');
  overlay.classList.add('fade-out');
  setTimeout(function() {
    overlay.classList.remove('active');
    overlay.classList.remove('fade-out');
  }, 400);
}

function handleFJOverlayClick(e) {
  if (e.target === document.getElementById('fj-overlay')) closeFJ();
}

/* ═══════════════════════════════════════════
   TIMER
   ═══════════════════════════════════════════ */
function resetTimer() {
  stopTimer();
  var total = parseInt(document.getElementById('timer-seconds').value) || 30;
  document.getElementById('timer-display').textContent = total;
  document.getElementById('timer-display').className = 'timer-display';
  document.getElementById('timer-fill').style.width = '100%';
  document.getElementById('timer-fill').classList.remove('danger');
  document.getElementById('timer-toggle').textContent = 'Start Timer';
  document.getElementById('timer-toggle').classList.remove('running');
  document.getElementById('screen-urgency').classList.remove('active');
  document.getElementById('screen-urgency').classList.remove('critical-pulse');
}

function toggleTimer() { timerRunning ? stopTimer() : startTimer(); }

function startTimer() {
  timerRunning = true;
  var total = parseInt(document.getElementById('timer-seconds').value) || 30;
  var remaining = parseInt(document.getElementById('timer-display').textContent);
  document.getElementById('timer-toggle').textContent = 'Pause';
  document.getElementById('timer-toggle').classList.add('running');

  timerInterval = setInterval(function() {
    remaining--;
    var display = document.getElementById('timer-display');
    display.textContent = remaining;
    var pct = (remaining / total) * 100;
    document.getElementById('timer-fill').style.width = pct + '%';

    if (remaining <= 10 && remaining > 7) {
      display.className = 'timer-display urgent';
      document.getElementById('timer-fill').classList.add('danger');
    }
    if (remaining <= 7 && remaining > 0) {
      display.className = 'timer-display critical';
      document.getElementById('screen-urgency').classList.add('active');
      document.getElementById('screen-urgency').classList.add('critical-pulse');
    }
    if (remaining <= 3 && remaining > 0) {
      if (!heartbeatInterval) {
        playHeartbeat();
        heartbeatInterval = setInterval(function() { playHeartbeat(); }, 350);
      }
    }
    if (remaining <= 0) {
      stopTimer();
      playTimesUpBuzzer();
      document.getElementById('screen-urgency').classList.remove('active');
      document.getElementById('screen-urgency').classList.remove('critical-pulse');
      document.getElementById('times-up-overlay').classList.add('active');
      document.getElementById('timer-toggle').textContent = "Time's Up!";
    }
  }, 1000);
}

function stopTimer() {
  timerRunning = false;
  if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
  if (heartbeatInterval) { clearInterval(heartbeatInterval); heartbeatInterval = null; }
  var btn = document.getElementById('timer-toggle');
  if (btn && btn.textContent !== "Time's Up!") {
    btn.textContent = 'Start Timer';
    btn.classList.remove('running');
  }
}

function dismissTimesUp() {
  document.getElementById('times-up-overlay').classList.remove('active');
}

/* ═══════════════════════════════════════════
   CONFETTI
   ═══════════════════════════════════════════ */
function launchConfetti() {
  var canvas = document.getElementById('confetti-canvas');
  var ctx = canvas.getContext('2d');
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  var pieces = [];
  var colors = ['#F2A900', '#003DA5', '#0077C8', '#00B2A9', '#FFFFFF', '#FFD700', '#FF6B6B', '#4EA8DE'];
  for (var i = 0; i < 250; i++) {
    pieces.push({
      x: Math.random() * canvas.width,
      y: -20 - Math.random() * 400,
      w: 5 + Math.random() * 10,
      h: 3 + Math.random() * 6,
      color: colors[Math.floor(Math.random() * colors.length)],
      vx: (Math.random() - 0.5) * 6,
      vy: 2 + Math.random() * 5,
      rotation: Math.random() * 360,
      rotSpeed: (Math.random() - 0.5) * 14,
      opacity: 1
    });
  }
  var frame = 0;
  function animate() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    var alive = false;
    for (var i = 0; i < pieces.length; i++) {
      var p = pieces[i];
      p.x += p.vx;
      p.y += p.vy;
      p.rotation += p.rotSpeed;
      p.vy += 0.06;
      p.vx *= 0.99;
      if (frame > 80) p.opacity -= 0.006;
      if (p.opacity > 0 && p.y < canvas.height + 50) {
        alive = true;
        ctx.save();
        ctx.translate(p.x, p.y);
        ctx.rotate(p.rotation * Math.PI / 180);
        ctx.globalAlpha = Math.max(0, p.opacity);
        ctx.fillStyle = p.color;
        ctx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
        ctx.restore();
      }
    }
    frame++;
    if (alive) requestAnimationFrame(animate);
    else ctx.clearRect(0, 0, canvas.width, canvas.height);
  }
  animate();
}

/* ═══════════════════════════════════════════
   CONTROLS
   ═══════════════════════════════════════════ */
function toggleSettings() { document.getElementById('settings-panel').classList.toggle('active'); }

var masterVolume = 0.8;
var globalGainNode = null;

function getGlobalGain() {
  if (!globalGainNode && audioCtx) {
    globalGainNode = audioCtx.createGain();
    globalGainNode.gain.value = masterVolume;
    globalGainNode.connect(audioCtx.destination);
  }
  return globalGainNode;
}

function toggleSound() {
  soundEnabled = !soundEnabled;
  document.getElementById('sound-toggle').innerHTML = soundEnabled ? '&#128266;' : '&#128264;';
  // Update slider to match
  if (!soundEnabled) {
    document.getElementById('volume-slider').value = 0;
    document.getElementById('volume-pct').textContent = 'MUTE';
    stopGameShowMusic();
  } else {
    var vol = Math.round(masterVolume * 100) || 80;
    if (masterVolume === 0) { masterVolume = 0.8; vol = 80; }
    document.getElementById('volume-slider').value = vol;
    document.getElementById('volume-pct').textContent = vol + '%';
    if (boardRevealed) startGameShowMusic();
  }
}

function toggleVolumeSlider() {
  document.getElementById('volume-slider-wrap').classList.toggle('active');
}

function adjustVolume(val) {
  masterVolume = val / 100;
  document.getElementById('volume-pct').textContent = val + '%';
  // Update icon based on level
  if (val == 0) {
    soundEnabled = false;
    document.getElementById('sound-toggle').innerHTML = '&#128264;';
    stopGameShowMusic();
  } else {
    if (!soundEnabled) {
      soundEnabled = true;
      document.getElementById('sound-toggle').innerHTML = '&#128266;';
      if (boardRevealed) startGameShowMusic();
    }
  }
  // Apply to music if playing
  if (musicNodes && musicNodes.masterGain) {
    try { musicNodes.masterGain.gain.setValueAtTime(masterVolume, audioCtx.currentTime); } catch(e) {}
  }
  // Apply to lo-fi if playing
  if (lofiPlaying && lofiMasterGain) {
    try { lofiMasterGain.gain.setValueAtTime(masterVolume * 0.35, audioCtx.currentTime); } catch(e) {}
  }
}

function resetGame() {
  if (!confirm('Reset the entire game? All progress will be lost.')) return;
  usedClues = {};
  fjUsed = false;
  currentProgressDisplay = 0;
  categoryTypewriterDone = false;
  gameStartTime = null;
  dailyDoublesHit = 0;
  victoryShown = false;
  resetDailyDoubles();
  buildBoard();
  // Re-trigger typewriter on reset
  if (boardRevealed) {
    setTimeout(typewriterCategories, 300);
  }
  document.getElementById('settings-panel').classList.remove('active');
}

function dismissSplash() {
  var splash = document.getElementById('splash');
  splash.classList.add('hidden');
  initAudio();
  
  // Play orchestral swell
  setTimeout(function() { playBoardRevealSwell(); }, 300);
  
  // Game show music removed — use lo-fi button instead
  
  // Reveal board with cascade
  setTimeout(function() { 
    revealBoard(); 
  }, 500);
  
  setTimeout(function() { splash.style.display = 'none'; }, 1200);
}

/* ═══════════════════════════════════════════
   CROWD REACTION SOUNDS
   ═══════════════════════════════════════════ */
function playCrowdMurmur() {
  if (!soundEnabled) return;
  initAudio();
  // Simulated crowd murmur: layered filtered noise bursts at different pitches
  for (var i = 0; i < 6; i++) {
    (function(idx) {
      setTimeout(function() {
        var bufferSize = audioCtx.sampleRate * 0.4;
        var buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
        var data = buffer.getChannelData(0);
        for (var j = 0; j < bufferSize; j++) { data[j] = (Math.random() * 2 - 1); }
        var source = audioCtx.createBufferSource();
        source.buffer = buffer;
        var filter = audioCtx.createBiquadFilter();
        filter.type = 'bandpass';
        filter.frequency.value = 300 + idx * 80;
        filter.Q.value = 1.5;
        var gain = audioCtx.createGain();
        var t = audioCtx.currentTime;
        gain.gain.setValueAtTime(0.001, t);
        gain.gain.linearRampToValueAtTime(0.04, t + 0.15);
        gain.gain.setValueAtTime(0.04, t + 0.3);
        gain.gain.exponentialRampToValueAtTime(0.001, t + 0.8);
        source.connect(filter);
        filter.connect(gain);
        gain.connect(audioCtx.destination);
        source.start(t);
        source.stop(t + 0.9);
      }, idx * 60);
    })(i);
  }
  // Excited "ooh" formant tones
  var oohFreqs = [280, 350, 420, 500];
  oohFreqs.forEach(function(freq, i) {
    setTimeout(function() {
      playTone(freq, 0.5, 'sine', 0.015);
    }, 100 + i * 40);
  });
}

function playCrowdApplause() {
  if (!soundEnabled) return;
  initAudio();
  var t = audioCtx.currentTime;
  // Multiple layers of filtered noise to simulate clapping
  for (var wave = 0; wave < 3; wave++) {
    (function(w) {
      var delay = w * 0.3;
      for (var i = 0; i < 12; i++) {
        (function(idx) {
          setTimeout(function() {
            var bufferSize = audioCtx.sampleRate * 0.06;
            var buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            var data = buffer.getChannelData(0);
            for (var j = 0; j < bufferSize; j++) { data[j] = (Math.random() * 2 - 1); }
            var source = audioCtx.createBufferSource();
            source.buffer = buffer;
            var filter = audioCtx.createBiquadFilter();
            filter.type = 'highpass';
            filter.frequency.value = 3000 + Math.random() * 2000;
            var gain = audioCtx.createGain();
            var now = audioCtx.currentTime;
            gain.gain.setValueAtTime(0.06 + Math.random() * 0.03, now);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 0.06);
            source.connect(filter);
            filter.connect(gain);
            gain.connect(audioCtx.destination);
            source.start(now);
            source.stop(now + 0.08);
          }, (delay + idx * 0.08 + Math.random() * 0.04) * 1000);
        })(i);
      }
    })(wave);
  }
  // Crowd cheering tones
  setTimeout(function() {
    var cheerFreqs = [600, 750, 900, 1100];
    cheerFreqs.forEach(function(freq) {
      var osc = audioCtx.createOscillator();
      var gain = audioCtx.createGain();
      osc.type = 'sine';
      osc.frequency.value = freq + Math.random() * 50;
      var now = audioCtx.currentTime;
      gain.gain.setValueAtTime(0.001, now);
      gain.gain.linearRampToValueAtTime(0.02, now + 0.3);
      gain.gain.exponentialRampToValueAtTime(0.001, now + 1.5);
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.start(now);
      osc.stop(now + 1.6);
    });
  }, 200);
}

/* ═══════════════════════════════════════════
   THINK MUSIC (Timer countdown music)
   ═══════════════════════════════════════════ */
function startThinkMusic() {
  if (!soundEnabled || thinkMusicNodes || thinkFading) return;
  initAudio();
  thinkMusicNodes = { active: true, timeouts: [], oscillators: [] };

  var masterGain = audioCtx.createGain();
  masterGain.gain.setValueAtTime(0.001, audioCtx.currentTime);
  masterGain.gain.linearRampToValueAtTime(1, audioCtx.currentTime + 0.5);
  masterGain.connect(audioCtx.destination);
  thinkMusicNodes.masterGain = masterGain;

  // Classic ascending/descending pattern, tempo ~120bpm
  var BPM = 120;
  var beatDur = 60 / BPM;

  // Pattern: ascending then descending, repeating with variations
  var patterns = [
    // Bar 1-2: ascending
    [262, 294, 330, 349, 392, 440, 494, 523],
    // Bar 3-4: descending
    [523, 494, 440, 392, 349, 330, 294, 262],
    // Bar 5-6: ascending with variation
    [262, 330, 392, 494, 523, 494, 392, 330],
    // Bar 7-8: resolving descent
    [440, 392, 349, 330, 294, 262, 247, 262],
  ];

  var noteIndex = 0;
  var patternIdx = 0;

  function scheduleThinkBar() {
    if (!thinkMusicNodes || !thinkMusicNodes.active) return;
    var pattern = patterns[patternIdx % patterns.length];
    var startTime = audioCtx.currentTime + 0.05;

    for (var i = 0; i < pattern.length; i++) {
      (function(idx, freq) {
        if (!thinkMusicNodes || !thinkMusicNodes.active) return;
        var noteTime = startTime + idx * (beatDur * 0.5);

        // Pizzicato-style pluck
        var osc = audioCtx.createOscillator();
        var gain = audioCtx.createGain();
        osc.type = 'triangle';
        osc.frequency.value = freq;
        gain.gain.setValueAtTime(0.001, noteTime);
        gain.gain.linearRampToValueAtTime(0.08, noteTime + 0.02);
        gain.gain.exponentialRampToValueAtTime(0.001, noteTime + beatDur * 0.45);
        osc.connect(gain);
        gain.connect(masterGain);
        osc.start(noteTime);
        osc.stop(noteTime + beatDur * 0.5);
        osc.onended = function() { try { osc.disconnect(); gain.disconnect(); } catch(e) {} };

        // Soft sine doubling for warmth
        var osc2 = audioCtx.createOscillator();
        var gain2 = audioCtx.createGain();
        osc2.type = 'sine';
        osc2.frequency.value = freq * 2;
        gain2.gain.setValueAtTime(0.001, noteTime);
        gain2.gain.linearRampToValueAtTime(0.025, noteTime + 0.02);
        gain2.gain.exponentialRampToValueAtTime(0.001, noteTime + beatDur * 0.4);
        osc2.connect(gain2);
        gain2.connect(masterGain);
        osc2.start(noteTime);
        osc2.stop(noteTime + beatDur * 0.5);
        osc2.onended = function() { try { osc2.disconnect(); gain2.disconnect(); } catch(e) {} };
      })(i, pattern[i]);
    }

    // Soft tick on each beat
    for (var b = 0; b < 4; b++) {
      (function(beat) {
        if (!thinkMusicNodes || !thinkMusicNodes.active) return;
        var tickTime = startTime + beat * beatDur;
        var bufferSize = audioCtx.sampleRate * 0.02;
        var buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
        var data = buffer.getChannelData(0);
        for (var j = 0; j < bufferSize; j++) { data[j] = (Math.random() * 2 - 1); }
        var source = audioCtx.createBufferSource();
        source.buffer = buffer;
        var filter = audioCtx.createBiquadFilter();
        filter.type = 'highpass';
        filter.frequency.value = 9000;
        var gain = audioCtx.createGain();
        gain.gain.setValueAtTime(beat === 0 ? 0.04 : 0.025, tickTime);
        gain.gain.exponentialRampToValueAtTime(0.001, tickTime + 0.03);
        source.connect(filter);
        filter.connect(gain);
        gain.connect(masterGain);
        source.start(tickTime);
        source.stop(tickTime + 0.04);
        source.onended = function() { try { source.disconnect(); filter.disconnect(); gain.disconnect(); } catch(e) {} };
      })(b);
    }

    patternIdx++;
    var barDuration = beatDur * 4;
    var tid = setTimeout(function() { scheduleThinkBar(); }, barDuration * 1000);
    if (thinkMusicNodes) thinkMusicNodes.timeouts.push(tid);
  }

  scheduleThinkBar();
}

var thinkFading = false;
function stopThinkMusic() {
  if (!thinkMusicNodes) return;
  thinkMusicNodes.active = false;
  if (thinkMusicNodes.timeouts) {
    thinkMusicNodes.timeouts.forEach(function(t) { clearTimeout(t); });
  }
  var fadingGain = thinkMusicNodes.masterGain;
  thinkMusicNodes = null;
  if (fadingGain) {
    thinkFading = true;
    try {
      fadingGain.gain.cancelScheduledValues(audioCtx.currentTime);
      fadingGain.gain.setValueAtTime(fadingGain.gain.value, audioCtx.currentTime);
      fadingGain.gain.linearRampToValueAtTime(0.001, audioCtx.currentTime + 0.4);
    } catch(e) {}
    setTimeout(function() {
      try { fadingGain.disconnect(); } catch(e) {}
      thinkFading = false;
    }, 500);
  }
}

/* ═══════════════════════════════════════════
   VICTORY CELEBRATION
   ═══════════════════════════════════════════ */
function checkVictory() {
  if (victoryShown) return;
  var total = CATEGORIES.length * VALUES.length;
  var answered = Object.keys(usedClues).length;
  if (answered >= total) {
    victoryShown = true;
    setTimeout(showVictory, 800);
  }
}

function showVictory() {
  // Calculate stats
  var elapsed = gameStartTime ? Math.floor((Date.now() - gameStartTime) / 1000) : 0;
  var mins = Math.floor(elapsed / 60);
  var secs = elapsed % 60;
  document.getElementById('v-stat-clues').textContent = Object.keys(usedClues).length;
  document.getElementById('v-stat-time').textContent = mins + ':' + (secs < 10 ? '0' : '') + secs;
  document.getElementById('v-stat-dd').textContent = dailyDoublesHit;

  // Play victory sounds
  playVictoryFanfare();
  setTimeout(playCrowdApplause, 600);

  // Show overlay
  document.getElementById('victory-overlay').classList.add('active');

  // Launch massive confetti
  var canvas = document.getElementById('victory-confetti-canvas');
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  launchVictoryConfetti(canvas);
}

function playVictoryFanfare() {
  if (!soundEnabled) return;
  initAudio();
  // Triumphant brass-like fanfare: C major arpeggio up to high C
  var fanfareNotes = [
    { freq: 262, time: 0, dur: 0.3 },
    { freq: 330, time: 0.15, dur: 0.3 },
    { freq: 392, time: 0.3, dur: 0.3 },
    { freq: 523, time: 0.5, dur: 0.5 },
    { freq: 659, time: 0.7, dur: 0.3 },
    { freq: 784, time: 0.9, dur: 0.4 },
    { freq: 1047, time: 1.2, dur: 0.8 },
  ];
  fanfareNotes.forEach(function(n) {
    setTimeout(function() {
      // Main tone
      playTone(n.freq, n.dur, 'sine', 0.12);
      // Harmonics
      playTone(n.freq * 1.5, n.dur * 0.8, 'sine', 0.04);
      playTone(n.freq * 2, n.dur * 0.6, 'sine', 0.02);
    }, n.time * 1000);
  });
  // Final sustained chord
  setTimeout(function() {
    [523, 659, 784, 1047].forEach(function(freq) {
      var osc = audioCtx.createOscillator();
      var gain = audioCtx.createGain();
      osc.type = 'sine';
      osc.frequency.value = freq;
      var t = audioCtx.currentTime;
      gain.gain.setValueAtTime(0.08, t);
      gain.gain.setValueAtTime(0.08, t + 1);
      gain.gain.exponentialRampToValueAtTime(0.001, t + 3);
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.start(t);
      osc.stop(t + 3.1);
    });
  }, 1600);
}

function launchVictoryConfetti(canvas) {
  var ctx = canvas.getContext('2d');
  var pieces = [];
  var colors = ['#F2A900', '#003DA5', '#0077C8', '#00B2A9', '#FFFFFF', '#FFD700', '#FF6B6B', '#4EA8DE', '#FF69B4', '#7B68EE'];
  // Way more confetti for victory
  for (var i = 0; i < 500; i++) {
    pieces.push({
      x: Math.random() * canvas.width,
      y: -20 - Math.random() * 600,
      w: 5 + Math.random() * 12,
      h: 3 + Math.random() * 8,
      color: colors[Math.floor(Math.random() * colors.length)],
      vx: (Math.random() - 0.5) * 8,
      vy: 2 + Math.random() * 6,
      rotation: Math.random() * 360,
      rotSpeed: (Math.random() - 0.5) * 16,
      opacity: 1
    });
  }
  var frame = 0;
  function animate() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    var alive = false;
    for (var i = 0; i < pieces.length; i++) {
      var p = pieces[i];
      p.x += p.vx;
      p.y += p.vy;
      p.rotation += p.rotSpeed;
      p.vy += 0.05;
      p.vx *= 0.995;
      if (frame > 120) p.opacity -= 0.004;
      if (p.opacity > 0 && p.y < canvas.height + 50) {
        alive = true;
        ctx.save();
        ctx.translate(p.x, p.y);
        ctx.rotate(p.rotation * Math.PI / 180);
        ctx.globalAlpha = Math.max(0, p.opacity);
        ctx.fillStyle = p.color;
        ctx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
        ctx.restore();
      }
    }
    frame++;
    if (alive) requestAnimationFrame(animate);
    else ctx.clearRect(0, 0, canvas.width, canvas.height);
  }
  animate();
}

function dismissVictory() {
  document.getElementById('victory-overlay').classList.remove('active');
}

/* ═══════════════════════════════════════════
   FULLSCREEN
   ═══════════════════════════════════════════ */
function toggleFullscreen() {
  if (!document.fullscreenElement && !document.webkitFullscreenElement) {
    var el = document.documentElement;
    if (el.requestFullscreen) el.requestFullscreen();
    else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
    document.getElementById('fullscreen-btn').innerHTML = '&#x2716;';
  } else {
    if (document.exitFullscreen) document.exitFullscreen();
    else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
    document.getElementById('fullscreen-btn').innerHTML = '&#x26F6;';
  }
}
document.addEventListener('fullscreenchange', function() {
  if (!document.fullscreenElement) {
    document.getElementById('fullscreen-btn').innerHTML = '&#x26F6;';
  }
});

/* ═══════════════════════════════════════════
   KEYBOARD HINTS
   ═══════════════════════════════════════════ */
function toggleKeyboardHints() {
  document.getElementById('keyboard-hints').classList.toggle('active');
}

/* ═══════════════════════════════════════════
   KEYBOARD SHORTCUTS
   ═══════════════════════════════════════════ */
document.addEventListener('keydown', function(e) {
  // Q = close modals (instead of ESC, which exits fullscreen)
  if (e.key === 'q' || e.key === 'Q') {
    closeClue(); closeFJ(); dismissTimesUp(); dismissVictory();
    document.getElementById('keyboard-hints').classList.remove('active');
  }
  // Space or Enter = reveal / dismiss
  if (e.key === ' ' || e.key === 'Enter') {
    e.preventDefault();
    if (document.getElementById('victory-overlay').classList.contains('active')) { dismissVictory(); return; }
    if (document.getElementById('times-up-overlay').classList.contains('active')) { dismissTimesUp(); return; }
    if (document.getElementById('dd-splash').classList.contains('active')) { dismissDD(); return; }
    if (document.getElementById('clue-overlay').classList.contains('active') && document.getElementById('reveal-btn').style.display !== 'none') { revealAnswer(); return; }
    if (document.getElementById('fj-overlay').classList.contains('active') && document.getElementById('fj-reveal-btn').style.display !== 'none') { revealFJAnswer(); return; }
    // If clue modal open but answer already revealed, close it
    if (document.getElementById('clue-overlay').classList.contains('active')) { closeClue(); return; }
    if (document.getElementById('fj-overlay').classList.contains('active')) { closeFJ(); return; }
  }
  // T = start/pause timer
  if (e.key === 't' || e.key === 'T') {
    if (document.getElementById('clue-overlay').classList.contains('active') &&
        document.getElementById('timer-bar-container').classList.contains('active')) {
      toggleTimer();
    }
  }
  // F = toggle fullscreen
  if (e.key === 'f' || e.key === 'F') {
    // Don't trigger if focus is in an input
    if (document.activeElement && document.activeElement.tagName === 'INPUT') return;
    toggleFullscreen();
  }
  // M = toggle sound
  if (e.key === 'm' || e.key === 'M') {
    if (document.activeElement && document.activeElement.tagName === 'INPUT') return;
    toggleSound();
  }
});

/* ═══════════════════════════════════════════
   INIT
   ═══════════════════════════════════════════ */
// Close volume slider when clicking elsewhere
document.addEventListener('click', function(e) {
  // Close lo-fi volume popup if clicking outside
  var lofiWrap = document.getElementById('lofi-vol-wrap');
  if (lofiWrap && lofiWrap.classList.contains('active')) {
    var lofiParent = e.target.closest('[oncontextmenu]') || e.target.closest('.lofi-vol-wrap');
    if (!lofiParent) lofiWrap.classList.remove('active');
  }
});

initSplash();
initParticles();
initCellSpotlights();
resetDailyDoubles();
buildBoard();

window.addEventListener('resize', function() {
  var c = document.getElementById('confetti-canvas');
  c.width = window.innerWidth;
  c.height = window.innerHeight;
  resizeParticleCanvas();
});
</script>
</body>
</html>
